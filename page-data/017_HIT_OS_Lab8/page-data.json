{"componentChunkName":"component---src-templates-blog-post-js","path":"/017_HIT_OS_Lab8/","result":{"data":{"site":{"siteMetadata":{"title":"JokerDebug"}},"markdownRemark":{"id":"d1f5cbae-a781-5527-9a6a-49f5dd153691","excerpt":"Github代码仓库链接 本节将更新哈工大《操作系统》课程第八个 Lab 实验 终端设备的控制。按照实验书要求，介绍了非常详细的实验操作流程，并提供了超级无敌详细的代码注释。 实验目的： 加深对操作系统设备管理基本原理的认识，实践键盘中断、扫描码等概念； 通过实践掌握 Linux 0.1…","html":"<p><a href=\"https://github.com/Joker001014/HIT-OSlab\">Github代码仓库链接</a></p>\n<p>本节将更新哈工大《操作系统》课程第八个 Lab 实验 <strong>终端设备的控制</strong>。按照实验书要求，介绍了非常详细的实验操作流程，并提供了超级无敌详细的代码注释。</p>\n<p><strong>实验目的：</strong></p>\n<blockquote>\n<ul>\n<li>加深对操作系统设备管理基本原理的认识，实践键盘中断、扫描码等概念；</li>\n<li>通过实践掌握 Linux 0.11 对键盘终端和显示器终端的处理过程。</li>\n</ul>\n</blockquote>\n<p><strong>实验任务：</strong></p>\n<blockquote>\n<p>本实验的基本内容是修改 Linux 0.11 的终端设备处理代码，对键盘输入和字符显示进行非常规的控制。\r\n在初始状态，一切如常。用户按一次 F12 后，把应用程序向终端输出所有字母都替换为<code class=\"language-text\">*</code>。用户再按一次 F12，又恢复正常。第三次按F12，再进行输出替换。依此类推。</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>文件名</th>\n<th>介绍</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>hit-操作系统实验指导书.pdf</td>\n<td>哈工大OS实验指导书</td>\n</tr>\n<tr>\n<td>Linux内核完全注释(修正版v3.0).pdf</td>\n<td>赵博士对Linux v0.11 OS进行了详细全面的注释和说明</td>\n</tr>\n<tr>\n<td>file1615.pdf</td>\n<td>BIOS 涉及的中断数据手册</td>\n</tr>\n<tr>\n<td>hit-oslab-linux-20110823.tar.gz</td>\n<td>hit-oslab 实验环境</td>\n</tr>\n<tr>\n<td>gcc-3.4-ubuntu.tar.gz</td>\n<td>Linux v0.11 所使用的编译器</td>\n</tr>\n<tr>\n<td><a href=\"https://joker001014.github.io/blog/019_HIT_OS_Bochs\">Bochs 汇编级调试指令</a></td>\n<td>bochs 基本调试指令大全</td>\n</tr>\n<tr>\n<td><a href=\"https://blog.csdn.net/yueyueniaolzp/article/details/82178954\">最全ASCII码对照表0-255</a></td>\n<td>屏幕输出字符对照的 ASCII 码</td>\n</tr>\n<tr>\n<td><a href=\"https://blog.csdn.net/weixin_53159274/article/details/138074386?spm=1001.2014.3001.5501\">x86_64 常用寄存器大全</a></td>\n<td>x86_64 常用寄存器大全</td>\n</tr>\n</tbody>\n</table>\n<h3>一、键盘输入处理</h3>\n<p>键盘中断发生步骤：</p>\n<ol>\n<li>键盘 I/O 是典型的中断驱动，在 <code class=\"language-text\">kernel/chr_drv/console.c</code> 文件中将键盘中断响应函数设为 <code class=\"language-text\">keyboard_interrupt</code>。每次按键有动作，<code class=\"language-text\">keyboard_interrupt</code> 函数就会被调用，函数定义在文件 <code class=\"language-text\">kernel/chr_drv/keyboard.S</code>中；</li>\n<li>根据扫描码，查 <code class=\"language-text\">key_table</code> 表进行扫描码处理，表中定义了相关所有扫描码对应键的处理函数，比如<code class=\"language-text\">f1-f12</code>键的处理则要先运行一段处理函数<code class=\"language-text\">func</code>；</li>\n<li>将扫描码放到键盘输入队列中，调用<code class=\"language-text\">do_tty_interrupt</code>函数进行处理。</li>\n</ol>\n<blockquote>\n<p>为了实现按<code class=\"language-text\">F12</code>实现切换，只需要定义一个切换函数，并将其放在<code class=\"language-text\">ket_table</code>中<code class=\"language-text\">F12</code>对应的处理函数位置即可。</p>\n</blockquote>\n<p>1、修改文件<code class=\"language-text\">linux-0.11/kernel/chr_drv/tty_io.c</code>，定义标志位，实现每按下一次<code class=\"language-text\">F12</code>标志位就会变化。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> switch_show_char_flag <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">void</span> <span class=\"token function\">press_F12_handle</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n    switch_show_char_flag <span class=\"token operator\">=</span> switch_show_char_flag <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>2、修改<code class=\"language-text\">linux-0.11/include/linux/tty.h</code>文件，将标志位和函数声明为全局。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> switch_show_char_flag<span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">void</span> <span class=\"token function\">press_F12_handle</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>3、修改<code class=\"language-text\">linux-0.11/kernel/chr_drv/keyboard.S</code>文件中<code class=\"language-text\">key_table</code>中<code class=\"language-text\">F12</code>对应的处理函数。</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">key_table<span class=\"token operator\">:</span>\r\n    <span class=\"token comment\">/* .long func,none,none,none         58-5B f12 ? ? ? */</span>\r\n    <span class=\"token punctuation\">.</span><span class=\"token keyword\">long</span> press_F12_handle<span class=\"token punctuation\">,</span>none<span class=\"token punctuation\">,</span>none<span class=\"token punctuation\">,</span>none <span class=\"token comment\">/* 58-5B f12 ? ? ? */</span></code></pre></div>\n<h3>二、屏幕输出控制</h3>\n<p>屏幕输出过程：</p>\n<ol>\n<li>输出字符到屏幕，系统调用<code class=\"language-text\">write</code>函数来进行；</li>\n<li><code class=\"language-text\">write</code>函数则会调用<code class=\"language-text\">sys_write</code>系统调用来实现字符输出；</li>\n<li>然后再调用<code class=\"language-text\">tty_write</code>函数；</li>\n<li>最终调用<code class=\"language-text\">con_write</code>函数将字符输出。</li>\n</ol>\n<blockquote>\n<p>故只需要修改<code class=\"language-text\">con_write</code>最终写到显存中的字符就可以了。具体修改文件<code class=\"language-text\">linux-0.11/kernel/chr_drv/console.c</code>，修改如下：</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">con_write</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">tty_struct</span> <span class=\"token operator\">*</span> tty<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n<span class=\"token comment\">//  ....</span>\r\n        <span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token keyword\">case</span> <span class=\"token number\">0</span><span class=\"token operator\">:</span>\r\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c<span class=\"token operator\">></span><span class=\"token number\">31</span> <span class=\"token operator\">&amp;&amp;</span> c<span class=\"token operator\">&lt;</span><span class=\"token number\">127</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x<span class=\"token operator\">>=</span>video_num_columns<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n                        x <span class=\"token operator\">-=</span> video_num_columns<span class=\"token punctuation\">;</span>\r\n                        pos <span class=\"token operator\">-=</span> video_size_row<span class=\"token punctuation\">;</span>\r\n                        <span class=\"token function\">lf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                    <span class=\"token punctuation\">}</span>\r\n\t\t\t\t\t<span class=\"token comment\">// 新增代码，若扫描码为大小写字母或者数字，则改为*</span>\r\n                    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>switch_show_char_flag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n                        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>c<span class=\"token operator\">>=</span><span class=\"token char\">'A'</span><span class=\"token operator\">&amp;&amp;</span>c<span class=\"token operator\">&lt;=</span><span class=\"token char\">'Z'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">||</span><span class=\"token punctuation\">(</span>c<span class=\"token operator\">>=</span><span class=\"token char\">'a'</span><span class=\"token operator\">&amp;&amp;</span>c<span class=\"token operator\">&lt;=</span><span class=\"token char\">'z'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">||</span><span class=\"token punctuation\">(</span>c<span class=\"token operator\">>=</span><span class=\"token char\">'0'</span><span class=\"token operator\">&amp;&amp;</span>c<span class=\"token operator\">&lt;=</span><span class=\"token char\">'9'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n                            c <span class=\"token operator\">=</span> <span class=\"token char\">'*'</span><span class=\"token punctuation\">;</span>\r\n                    <span class=\"token punctuation\">}</span></code></pre></div>\n<h3>三、编译并运行</h3>\n<p>1、编译并运行</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> oslab_Lab7/linux-0.11\r\n<span class=\"token function\">make</span> all\r\n<span class=\"token punctuation\">..</span>/run</code></pre></div>\n<p>2、测试结果</p>\n<p>在 Bochs 中进行测试：</p>\n<ul>\n<li>若没有按下<code class=\"language-text\">F12</code>，输出为正常显示；</li>\n<li>若按下<code class=\"language-text\">F12</code>，则数字和字母的回显变为<code class=\"language-text\">*</code>；</li>\n<li>且再次按下<code class=\"language-text\">F12</code>，显示将恢复正常。</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 610px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/c8adf9a771ef3505be2dcf0eeea3b598/5aae9/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.45569620253164%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACBklEQVR42m1SyW4aURAc9n3f90XwKQixCsHFAUfiYCASh9g4ImDfnJwwBxbZGPKxlalOHspIObS6e169qup+o00nE0zv7vBlNsPTaoXXzQYfpxM+3k84/83sf53Pen7H2/GIHy8v+KnHbDrBp5sbPNzf49tigc3yK7ThcIjPt7dYPD5iu93icrlgfzhgv9/jqF9mHPR+t9tJvdEF5/M5lsslxuMxRqMR1us1np6fsfi+ghaLxRAKheDxeGCz2eBwOKBpGpxOJ0wmk9R2u/167nK54Pf7EYlEBMNzQyQSCZA0GAwiHA6DvdVqRT6fh8VikYjH46hUKohGo8hkMlIXCgUhNpvNhtAIIhEPSUplHqRSqT8AXZXfi8WiTJJOp1EqleScvcJcgwA6CAQCQpZMJsUVCRSY36rVqjjM5XJSk5QuKWYgzGazokZSEnJ87o4kzGpkjsrLJOU6aMTn88lkxBh2qBxyyepRmP99FPbMfBj1OMycQuEkqMjwer2ixn0SRCE1MsUoSocM1nRIvIGMQQCX63a7rw9DIo6uCPnLUJTEDNYU/O9vQyX1YgSy5mhcODNB3C17kjC4w3K5LC45mdq17JIf6I5qzOzpTDklIfdFZ3RKDGueU5D/rMFhr9dDv9/HYDBAvV5HrVaT3Gq1pG40GlI3m0202210Oh2Jbrcrwfsqk+c30VVuiho3CqcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/c8adf9a771ef3505be2dcf0eeea3b598/5aae9/1.png\"\n        srcset=\"/blog/static/c8adf9a771ef3505be2dcf0eeea3b598/c26ae/1.png 158w,\n/blog/static/c8adf9a771ef3505be2dcf0eeea3b598/6bdcf/1.png 315w,\n/blog/static/c8adf9a771ef3505be2dcf0eeea3b598/5aae9/1.png 610w\"\n        sizes=\"(max-width: 610px) 100vw, 610px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>","frontmatter":{"title":"【哈工大_操作系统实验】Lab8 终端设备的控制","date":"October 21, 2024","description":"本文将介绍哈工大操作系统实验课Lab8 终端设备的控制"}},"previous":{"fields":{"slug":"/016_HIT_OS_Lab7/"},"frontmatter":{"title":"【哈工大_操作系统实验】Lab7 地址映射与共享"}},"next":{"fields":{"slug":"/018_HIT_OS_Lab9/"},"frontmatter":{"title":"【哈工大_操作系统实验】Lab9 proc文件系统的实现"}}},"pageContext":{"id":"d1f5cbae-a781-5527-9a6a-49f5dd153691","previousPostId":"6f3e8248-ac12-5c84-862d-01d2e442249c","nextPostId":"5b72faa2-f907-5295-ae99-c950f530818a"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}