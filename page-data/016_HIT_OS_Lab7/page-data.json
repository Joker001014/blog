{"componentChunkName":"component---src-templates-blog-post-js","path":"/016_HIT_OS_Lab7/","result":{"data":{"site":{"siteMetadata":{"title":"JokerDebug"}},"markdownRemark":{"id":"6f3e8248-ac12-5c84-862d-01d2e442249c","excerpt":"Github代码仓库链接 本节将更新哈工大《操作系统》课程第七个 Lab…","html":"<p><a href=\"https://github.com/Joker001014/HIT-OSlab\">Github代码仓库链接</a></p>\n<p>本节将更新哈工大《操作系统》课程第七个 Lab 实验 <strong>地址映射与共享</strong>。按照实验书要求，介绍了非常详细的实验操作流程，并提供了超级无敌详细的代码注释。</p>\n<p><strong>实验目的：</strong></p>\n<blockquote>\n<ul>\n<li>深入理解操作系统的段、页式内存管理，深入理解段表、页表、逻辑地址、线性地址、物理地址等概念；</li>\n<li>实践段、页式内存管理的地址映射过程；</li>\n<li>编程实现段、页式内存管理上的内存共享，从而深入理解操作系统的内存管理。</li>\n</ul>\n</blockquote>\n<p><strong>实验任务：</strong></p>\n<blockquote>\n<p>1、用 Bochs 调试工具跟踪 Linux 0.11 的地址翻译（地址映射）过程，了解 IA-32 和 Linux 0.11 的内存管理机制；\r\n2、在 Ubuntu 上编写多进程的生产者—消费者程序，用共享内存做缓冲区；\r\n3、在信号量实验的基础上，为 Linux 0.11 增加共享内存功能，并将生产者—消费者程序移植到 Linux 0.11。</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>文件名</th>\n<th>介绍</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>hit-操作系统实验指导书.pdf</td>\n<td>哈工大OS实验指导书</td>\n</tr>\n<tr>\n<td>Linux内核完全注释(修正版v3.0).pdf</td>\n<td>赵博士对Linux v0.11 OS进行了详细全面的注释和说明</td>\n</tr>\n<tr>\n<td>file1615.pdf</td>\n<td>BIOS 涉及的中断数据手册</td>\n</tr>\n<tr>\n<td>hit-oslab-linux-20110823.tar.gz</td>\n<td>hit-oslab 实验环境</td>\n</tr>\n<tr>\n<td>gcc-3.4-ubuntu.tar.gz</td>\n<td>Linux v0.11 所使用的编译器</td>\n</tr>\n<tr>\n<td><a href=\"https://blog.csdn.net/weixin_53159274/article/details/137796343?spm=1001.2014.3001.5501\">Bochs 汇编级调试指令</a></td>\n<td>bochs 基本调试指令大全</td>\n</tr>\n<tr>\n<td><a href=\"https://blog.csdn.net/yueyueniaolzp/article/details/82178954\">最全ASCII码对照表0-255</a></td>\n<td>屏幕输出字符对照的 ASCII 码</td>\n</tr>\n<tr>\n<td><a href=\"https://blog.csdn.net/weixin_53159274/article/details/138074386?spm=1001.2014.3001.5501\">x86_64 常用寄存器大全</a></td>\n<td>x86_64 常用寄存器大全</td>\n</tr>\n</tbody>\n</table>\n<h3>一、IA-32 的地址翻译过程</h3>\n<p>1、启动调试器</p>\n<ul>\n<li>将 <code class=\"language-text\">test.c</code> 测试程序拷贝到 linux0.11 系统下</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> oslab_Lab6\r\n<span class=\"token function\">sudo</span> ./mount-hdc\r\n<span class=\"token function\">cp</span> test.c hdc/usr/root/\r\n<span class=\"token function\">sudo</span> <span class=\"token function\">umount</span> hdc\r\n// 启动 linux-0.11\r\n./dbg-asm\r\nc              // 运行到断点位置</code></pre></div>\n<blockquote>\n<p>Next at t=0 表示下面的指令是 Bochs 下一条要执行的软件指令</p>\n</blockquote>\n<p>2、编译并运行 test.c</p>\n<ol>\n<li>linux-0.11 系统下编译运行 <code class=\"language-text\">test.c</code></li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">gcc <span class=\"token parameter variable\">-o</span> <span class=\"token builtin class-name\">test</span> test.c\r\n./test\r\n// 输出：The logical/virtual address of i is 0x00003004</code></pre></div>\n<blockquote>\n<p>test 是一个死循环，只会不停占用 CPU，不会退出。</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 417px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/7368fbc2bd4d37057eaf6a23e3e345b6/f27fb/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.822784810126581%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAh0lEQVR42n2MTQuEIBRFX0G6qQgS/AjLRSEqhSBuI/T//6d5M8Ns5ywu3AvnghBCKcU511pv27Z8oJT2fT/P8zAMjLFxHAkhANA0Dfzoug6klOu6ooymMWaapm9t2xb+8pZzzs45zJTSeZ7e++u6sB7HgUuM0VqLI17v+x5CeJ6nlFJrve/7BYSnET6v0sNFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/7368fbc2bd4d37057eaf6a23e3e345b6/f27fb/1.png\"\n        srcset=\"/blog/static/7368fbc2bd4d37057eaf6a23e3e345b6/c26ae/1.png 158w,\n/blog/static/7368fbc2bd4d37057eaf6a23e3e345b6/6bdcf/1.png 315w,\n/blog/static/7368fbc2bd4d37057eaf6a23e3e345b6/f27fb/1.png 417w\"\n        sizes=\"(max-width: 417px) 100vw, 417px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ol start=\"2\">\n<li>暂停</li>\n</ol>\n<ul>\n<li>在命令行窗口按 <code class=\"language-text\">Ctrl+c</code>，Bochs 会暂停运行态。绝大多数情况下都会停在 test 内。</li>\n<li>其中的 000f 如果是 0008，则说明中断在了内核里。那么就要 <code class=\"language-text\">c</code>，然后再 <code class=\"language-text\">Ctrl+c</code>，直到变为 000f 为止。</li>\n<li>如果显示的下一条指令不是 cmp ...（这里指语句以 cmp 开头），就用 <code class=\"language-text\">n</code> 命令单步运行几步，直到停在 cmp ...。</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 612px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/75c62ae7c69c6f44a3d20932741bbca5/8c76f/2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.708860759493675%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABW0lEQVR42j1R2XLCMAx0yEVuiO0cXDMllIRjaFL6QIeH/v9Xbdee0oedlSJptVbEdt+g0BGKskS20ITCQtaQ1Qqlbi0rXaGqKkgpkSQJoiiy/EIcJxBC4Ha7QRRFYRODMAyR5ymRQSlJgRJNU6PkMtNnEMeRrTuzGVzXhUf4vm/nx3GEOJ/P2G432O12SNMUWZahqmvUhFKagg20UpCltA5N3ratjZfLpe0Pg8AK9n0PMU0Tum6P4/GIIPBtsX4JckjSXV1XFFdWOM9zRPM5XDp0HOcfRrDrOoh+GOw2M2BuMU+5kU59DnlEwAVzchTH8HiSgBwksX2yEXE9zy4x5xoGOjTOrJtKY6M1fnj8O1198CkXHt80uhRtyROFr1x6IZ/47UrxK+Ml2Wf9RHPicHjHer3G8TTgbbXCk4U78aDYyCFzcMfzsSE/mX8aMDb4+utrzU9bLPD9eOAXV5SogDQOPFMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/75c62ae7c69c6f44a3d20932741bbca5/8c76f/2.png\"\n        srcset=\"/blog/static/75c62ae7c69c6f44a3d20932741bbca5/c26ae/2.png 158w,\n/blog/static/75c62ae7c69c6f44a3d20932741bbca5/6bdcf/2.png 315w,\n/blog/static/75c62ae7c69c6f44a3d20932741bbca5/8c76f/2.png 612w\"\n        sizes=\"(max-width: 612px) 100vw, 612px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>使用命令 <code class=\"language-text\">u /8</code>，显示从当前位置开始 8 条指令的反汇编代码。</li>\n<li>这就是 test.c 中从 while 开始一直到 return 的汇编代码。变量 i 保存在 ds:0x3004 这个地址，并不停地和 0 进行比较，直到它为 0，才会跳出循环。</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 604px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/3ff8ad2ab10df44fc331cd2e5a4857c5/87254/3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80.37974683544303%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAADXklEQVR42kVTaZPaRhTU//+Ycn6AK1WpHE68VU4Wew9vebnZRYAAARISICRxCh3cQqjTmk2cD11vNHrzpl+/HunmcxXv/pDx442CHz408O7Ppog/33fxy10Dvz20GBX8lGvi18cebvI63t8beP9g/B/FWsdNwYRkGgrmdhP2WIZrNQWWbhuW+YphvyiiqVWgqUUsHAX+qo9ooyPcaNj6Q4HI1xn5Hc0hBb4FJDNc4xmSk4PVTEXo6ZgYr5iOZBasi2Ku1eLFbe41RBFn0sB5b+FytBEfplxPcDpuINVfnvFayaFWysHUa7zNYHITvXYehlbFePiCQbdIllVxSXaB3itDVZ5hDCqYTRXmtxCsB9jv1pBqlSfUq19QLd7CGjcAbOCtNCZXReHsgEuMM8b8705bWM1V7KIR4qMDXJfscAGkK1ySLSSlWRY6ZS0tnA5CMswO+GsNm9UA28DE7l94y7dvb9nHnLnb0PxecMM9b21DajYK6Hee+XOEPTXZR2PsuU6ZKMDk77gsxN71Mheap8lcMBPg+nIOIA21BrWrQu8UoMlfYVIXje3a3JtSv4gsIzIOGXeehnChIlj04BEBh5chk8UavWLjOZD0Xh2TUR0L+RFntYC4fo+rrQBMSKdNpOM6Ur2ClC2l1C9lN6nyhOvZFSz/Y5ucbDL0s5ZLMIY1mJyk/PUjWuUcJShgxGna1DXTdLud0GMjHA42ArJdk0AYTThVC/5miCXZhtTWD+jDZv4L5IcPWNAyI+UbVmxz3i/DY0zYYobTvIu902ZUceawDmw75MQPsw527ManX3d2C7HHoXQ/f0Tl7neopVvY3QLS7RigUbGbAGSVUKMdi61pG7dfwowab7MifFlbt4MNC49b3xBYDSSjDqTWUw75/Cc4TDpRl5QTS9OlANI14rODGQ9O2X5fLWFA9jNa5sKJX69rROEEartI//q4zg22/Pg3iizo0u3JiQUpcgZhVuJMtjZZZK9jyGIT44VvvSumG/PZBZRArt4JC11nQxZ8+Avl8i3mZJHwVmD95qvMsETM9z2hRg4n7FPPBXXLBiTy4CEKDL4wWXxfHA1S5/EWCjW0ag8IBjUc+fhji7aZ9QSuThcHU0Y8bfOM/obFAKmrgtPDkZ3txxwIc0NDxT+tQIfC1utS3wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/3ff8ad2ab10df44fc331cd2e5a4857c5/87254/3.png\"\n        srcset=\"/blog/static/3ff8ad2ab10df44fc331cd2e5a4857c5/c26ae/3.png 158w,\n/blog/static/3ff8ad2ab10df44fc331cd2e5a4857c5/6bdcf/3.png 315w,\n/blog/static/3ff8ad2ab10df44fc331cd2e5a4857c5/87254/3.png 604w\"\n        sizes=\"(max-width: 604px) 100vw, 604px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>3、查段表，计算 DS 线性地址</p>\n<ol>\n<li>LDT 表位置</li>\n</ol>\n<ul>\n<li>ds:0x3004 是虚拟地址，应用程序都有一个段表，叫 LDT。</li>\n<li><code class=\"language-text\">ldtr</code> 寄存器表示 LDT表 存放在 GDT 表的位置。</li>\n<li><code class=\"language-text\">sreg</code> 指令显示</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;bochs:2> sreg\r\ncs:s=0x000f, dl=0x00000002, dh=0x10c0fa00, valid=1\r\nds:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=3\r\nss:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1\r\nes:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1\r\nfs:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1\r\ngs:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=1\r\nldtr:s=0x0068, dl=0xa2d00068, dh=0x000082fa, valid=1\r\ntr:s=0x0060, dl=0xa2e80068, dh=0x00008bfa, valid=1\r\ngdtr:base=0x00005cb8, limit=0x7ff\r\nidtr:base=0x000054b8, limit=0x7ff</code></pre></div>\n<ul>\n<li>0x0068=0000000001101000，则存放在 GDT 表的 1101（二进制）=13（十进制）号位置</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 439px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/9b9e6582f2624012996b8b5cb8aaa3b1/e3b18/4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.822784810126581%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAiklEQVR42j1OQQ6EIBDj//8jKkQUEFEhBJcHdNM5eGjoTNuhSmsN7z1aayilCO77xvM831xr/d4QAmKMOI4D53nKTC938zxDkdDsnMO+7wIeZ4AfbdsmGjm9YwzRya/rkiy13rt4FYNsxKbLssAYg5yziNZa2VEzxmJdHd73J42YI1JKovPwNE34A8pX299mzDYmAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/9b9e6582f2624012996b8b5cb8aaa3b1/e3b18/4.png\"\n        srcset=\"/blog/static/9b9e6582f2624012996b8b5cb8aaa3b1/c26ae/4.png 158w,\n/blog/static/9b9e6582f2624012996b8b5cb8aaa3b1/6bdcf/4.png 315w,\n/blog/static/9b9e6582f2624012996b8b5cb8aaa3b1/e3b18/4.png 439w\"\n        sizes=\"(max-width: 439px) 100vw, 439px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ol start=\"2\">\n<li>在 GDT 表中查找 LDT 表</li>\n</ol>\n<ul>\n<li>GDT 表中的每一项占 64 位（8 个字节），所以我们要查找的项的地址是 <code class=\"language-text\">0x00005cb8+13*8</code>。<code class=\"language-text\">xp</code> 是用于<strong>查看内存内容</strong>的调试指令，w表示显示两个字（b-BYTE, h-WORD, <strong>w-DWORD</strong>, g-DWORD64）</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token operator\">&lt;</span>bochs:<span class=\"token operator\"><span class=\"token file-descriptor important\">5</span>></span> xp /2w 0x00005cb8+13*8\r\n<span class=\"token punctuation\">[</span>bochs<span class=\"token punctuation\">]</span>:\r\n0x00005d20 <span class=\"token operator\">&lt;</span>bogus+       <span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span>:    0xa2d00068    0x000082fa</code></pre></div>\n<blockquote>\n<p>此时可以发现，和前面<code class=\"language-text\">sreg</code>指令中<code class=\"language-text\">ldtr</code>后面的<code class=\"language-text\">dl</code>和<code class=\"language-text\">dh</code>值一样（这是Bochs 调试器自动计算出的）</p>\n</blockquote>\n<ol start=\"3\">\n<li>利用 GDT 表中描述符计算 LDT 表线性地址</li>\n</ol>\n<ul>\n<li>描述符为“0xa2d00068 0x000082fa”，->  <code class=\"language-text\">0x 00 fa a2d0</code> （前面32位对应下面行，后面32位对应上面行）</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 576px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/2a2c19c14d393ac4cb48a731bf4d1008/533c1/5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.21518987341772%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAy0lEQVR42j1QiQqFMAzz//9QnfftvBUVUfNIwDcI6do0XeeUZYmu65CmKYZhQBiGMMbA9314nicmmI/jWExtURSCtRZZlsmjrms467riui64rivu+x5VVcksSRIZsJHiPM/RNA34CGq2bQP7jQlw37dihwbzPKtIJsZxRNu2ms47mZimSQO5CfXULcsiI9ZkyMT7vprAw5ewied5HoHm53lK9+W45r7v/17ycRxwuAb3ZxONgiBAFMXKWduKuTLrjD/wSzicMb/h+8sflPF4HL1op9wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/2a2c19c14d393ac4cb48a731bf4d1008/533c1/5.png\"\n        srcset=\"/blog/static/2a2c19c14d393ac4cb48a731bf4d1008/c26ae/5.png 158w,\n/blog/static/2a2c19c14d393ac4cb48a731bf4d1008/6bdcf/5.png 315w,\n/blog/static/2a2c19c14d393ac4cb48a731bf4d1008/533c1/5.png 576w\"\n        sizes=\"(max-width: 576px) 100vw, 576px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>根据该地址，找到了 LDT 表位置，前4项内容为（每一项也是64位）：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token operator\">&lt;</span>bochs:<span class=\"token operator\"><span class=\"token file-descriptor important\">7</span>></span> xp /8w 0x00faa2d0\r\n<span class=\"token punctuation\">[</span>bochs<span class=\"token punctuation\">]</span>:\r\n0x00faa2d0 <span class=\"token operator\">&lt;</span>bogus+ <span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span>: 0x00000000 0x00000000\r\n0x00000002 0x10c0fa00\r\n0x00faa2e0 <span class=\"token operator\">&lt;</span>bogus+ <span class=\"token number\">1</span><span class=\"token operator\"><span class=\"token file-descriptor important\">6</span>></span>: 0x00003fff 0x10c0f300\r\n0x00000000 0x00fab000</code></pre></div>\n<ol start=\"4\">\n<li>段寄存器（段选择子） DS 从 LDT 表获取段描述符</li>\n</ol>\n<ul>\n<li><code class=\"language-text\">sreg</code>指令获取 DS 寄存器内容</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;bochs:8> sreg\r\nds:s=0x0017, dl=0x00003fff, dh=0x10c0f300, valid=3</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 435px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/24cc84ae184468df4d6718c99e4cabc7/330eb/6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.455696202531648%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAh0lEQVR42l1P0QrEIAzb//+d4IGDqdM5UVTmYO85Urg93ENoYpPWLkopbNuGUgrO80TOGSmll//Dew9rLfZ9F5DTzxpCwELRexcjH4g5p4RDiKJ/veM48DwP7vuWhfzEdV2IMWKMIXyhiQ2tNdZ1hTFGhjnnXq31RzgvYai1JkMIepnlglorvhKu2yrt7ELFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/24cc84ae184468df4d6718c99e4cabc7/330eb/6.png\"\n        srcset=\"/blog/static/24cc84ae184468df4d6718c99e4cabc7/c26ae/6.png 158w,\n/blog/static/24cc84ae184468df4d6718c99e4cabc7/6bdcf/6.png 315w,\n/blog/static/24cc84ae184468df4d6718c99e4cabc7/330eb/6.png 435w\"\n        sizes=\"(max-width: 435px) 100vw, 435px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<ul>\n<li>RPL：即如果 RPL 的数值大于 CPL（数值越大，权限越小），则用 RPL 的值覆盖 CPL 的值，即 CPR, RPL ≤ DPL</li>\n<li>TI：TI=0，在 GDT 表中查； TI = 1，在 LDT 表中查。</li>\n</ul>\n</blockquote>\n<ul>\n<li>ds = 0x0017 = 0001 0111，即RPL = 11， TI = 1，索引 = 10，即在 LDT 表中索引为 2 的描述符（即第三个），即<code class=\"language-text\">0x00003fff 0x10c0f300</code> 为搜寻很久的 DS 段描述符了。</li>\n</ul>\n<blockquote>\n<p>此时可以发现，和前面<code class=\"language-text\">sreg</code>指令中<code class=\"language-text\">ds</code>后面的<code class=\"language-text\">dl</code>和<code class=\"language-text\">dh</code>值一样（这是Bochs 调试器自动计算出的）</p>\n</blockquote>\n<p>总结：</p>\n<ul>\n<li>根据段选择子<code class=\"language-text\">ldtr</code>在GDT表中找到了LDT表中的段描述符，计算线性地址，该线性地址其实bochs调试器在<code class=\"language-text\">ldtr</code>寄存器后面的dh、dl中已经计算好了，可以供我们验证；</li>\n<li>根据段选择子<code class=\"language-text\">DS</code>在LDT表中找到DS的段描述符，计算线性地址，该线性地址其实bochs调试器在<code class=\"language-text\">DS</code>寄存器后面的dh、dl中已经计算好了，可以供我们验证。</li>\n</ul>\n<ol start=\"5\">\n<li>利用 LDT 表中段描述符计算 DS 线性地址（段基址）</li>\n</ol>\n<ul>\n<li>由段描述符<code class=\"language-text\">0x00003fff 0x10c0f300</code> 可以计算得到段基址为<code class=\"language-text\">0x 10 00 0000</code>，所以 <code class=\"language-text\">ds:0x3004</code> 的线性地址为 <code class=\"language-text\">0x100003004</code>。</li>\n<li>使用 <code class=\"language-text\">cals ds:0x3004</code> 可以验证该结果</li>\n</ul>\n<p>4、查页表，由线性地址计算物理地址</p>\n<blockquote>\n<p>即计算 页目录号（10位）、页表号（10位）和页内偏移（12位）</p>\n</blockquote>\n<ul>\n<li>线性地址 <code class=\"language-text\">0x100003004</code>：页目录号 = 64， 页号 = 3， 页内偏移 = 4</li>\n</ul>\n<ol>\n<li>在页目录表中查找</li>\n</ol>\n<ul>\n<li>页目录表的位置由 CR3 寄存器指引，<code class=\"language-text\">creg</code>命令可以查看：</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 607px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/845c427f05da9d5245501b7765db8eae/ef9e5/7.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.37974683544304%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaElEQVR42n2Q20oCARCG9z0iKqttpahIQ7PwmIpoaUTZObrsosxDBR18h6jrMCwqfJF8ASUhbyuj2DXEQ+jXtnUTRD/8/DMDM/PPCOGFOUwmI1arBavNwuCgHrFPh14v0j8gIel7GDEM4XDamHQ7cLuduCbtrK0vk8/nyeVyvyisb6xithgZnzBhHjMQDs9ydHzA3n6co+S33lxf8YVKpUK93qDR+OZfEL4cGoxD6nYbJrOBWHyHTOaWdPqCy6s01+qwVOqcbPZOa2i1WvwHwef3Iko6xiyjGEeHkaRuOjrb6BU70XW3I6raK3Zp5yaThxQK95pTWZZRFOUXy2VFdbg4j8frYnFpjuWVMIEpHzMz02o+TygUIBj0a2/w+T3YHRNsbW2yu5cgGouQSESJxyPEtDim1rYRTs9OKBYfaDabVKtVjbVaTf1RXdOalv/UPhq8v5eRFfnHoczb2ysvLyVKpWeenh75BO0yTgyZ5vP4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/845c427f05da9d5245501b7765db8eae/ef9e5/7.png\"\n        srcset=\"/blog/static/845c427f05da9d5245501b7765db8eae/c26ae/7.png 158w,\n/blog/static/845c427f05da9d5245501b7765db8eae/6bdcf/7.png 315w,\n/blog/static/845c427f05da9d5245501b7765db8eae/ef9e5/7.png 607w\"\n        sizes=\"(max-width: 607px) 100vw, 607px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>说明页目录表的基址为 0</li>\n<li>页目录表和页表中的内容很简单，是 1024 （2^10）个 32 位数，表大小刚好为4K。用以下指令可以在页目录表中查找到页目录项为</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">xp /w <span class=\"token number\">0</span>+64*4\r\n// 0x00000100 <span class=\"token builtin class-name\">:</span> 0x00fa5027</code></pre></div>\n<ol start=\"2\">\n<li>在页表中查找</li>\n</ol>\n<ul>\n<li>上述可得页表所在物理内存位置为 <code class=\"language-text\">0x00faa</code>位置（027是属性），得3号页表项为：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">xp /w 0x00faa000+3*4\r\n// 0x00fa500c <span class=\"token builtin class-name\">:</span> 0x00f9b067</code></pre></div>\n<ol start=\"3\">\n<li>计算物理地址</li>\n</ol>\n<p>物理页框号为 0x00f9b（067是属性），和页内偏移 0x004，得到 <code class=\"language-text\">0x00f9b004</code>，这就是变量 i 的物理地址。</p>\n<p>可以通过两种方式验证：</p>\n<ul>\n<li>基于线性地址 <code class=\"language-text\">0x10003004</code> ，使用 <code class=\"language-text\">page</code> 指令：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">page 0x10003004\r\nlinear page 0x10003000 maps to physical page 0x00f9b000</code></pre></div>\n<ul>\n<li>基于物理地址 <code class=\"language-text\">0x00fa7004</code>，使用 <code class=\"language-text\">xp</code> 指令查看地址中存放的一个字节：</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">xp /w 0x00f9b004\r\n0x00fa7004 <span class=\"token builtin class-name\">:</span> 0x12345678</code></pre></div>\n<p>5、修改内存来改变 i 的值，使程序退出循环</p>\n<ul>\n<li>将从 0x00f9b004 地址开始的 4 个字节都设为 0</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">setpmem 0x00f9b004 <span class=\"token number\">4</span> <span class=\"token number\">0</span></code></pre></div>\n<ul>\n<li>然后再用 <code class=\"language-text\">c</code> 命令继续 Bochs 的运行，可以看到 test 退出了，说明 i 的修改成功了，此项实验结束。</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 416px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/e058838755b0953f93793c47964f08a9/b0122/8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 17.088607594936708%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAgElEQVR42n2NsQrEIABD9RQpDoqV1oqtiO1S0cni/39aw91+GR6BkIR472OMYEoJZt93UEqplHLOaa23bTPGTNNEKf18xRgDhRAEWQhhXVd0cs7zPKNvrUVM/opzTmqt+Lzvu5RynudxHGBrDbfXdcH/1nG+LAvS3vvzPGOM3vsLc+gOv1KU5nQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/e058838755b0953f93793c47964f08a9/b0122/8.png\"\n        srcset=\"/blog/static/e058838755b0953f93793c47964f08a9/c26ae/8.png 158w,\n/blog/static/e058838755b0953f93793c47964f08a9/6bdcf/8.png 315w,\n/blog/static/e058838755b0953f93793c47964f08a9/b0122/8.png 416w\"\n        sizes=\"(max-width: 416px) 100vw, 416px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>二、在 Linux 0.11 中实现共享内存</h3>\n<p>本次实验将在 <code class=\"language-text\">Lab6 信号量的实现和应用</code> 实验的基础上，使用共享内存替换文件缓冲区，来完成生产者和消费者两个程序。</p>\n<blockquote>\n<p>Linux 中，将不同进程的虚拟地址空间通过页表映射到物理内存的同一区域，实现共享内存。</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 613px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/6c51f44aa13a2129497a9a2a2f06b013/5754a/9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.77215189873418%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABT0lEQVR42nVRy3KDMAzk/3+ilx76Sqad6aH/0EvbYy9tyANsAhgwBjvIW4HTJO0kntFIzIqVdhUlWYmNzKFqDdO2aP9Fo1uoxkCfwcYwhvG6QcIcWaEQJXKLNMtx6fW9RSYlnHMXe4gIq0SgVBWiMi+hhAyI9yGmMuRBl7BfrxhMdew5zSOhMcgXS2jTIZqwbIuqUqhaHXqnCD9Qr+GST87tCRZeUQmoIgHy/DAgCrosXPoMt3gAj4EjDzcQrzfAqwJUC3iZjvphB48dSwT7St9XIDHnqUf50WGqnMGLW4CPs5YNYlHDlwpUSNjlB8uqQfwdiwYbwfJrw/03IPm4pzrdkOtxkhf34OWwKjvEWzPVxN71izdQp8HLIc4N1kUXlkivmXD250DRb+HlnEnvgm/sB9Hew7aCi9+ZsNlf1E/4iA7yCU6+wO0Izlp2pMcP3KhqokqK2UcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/6c51f44aa13a2129497a9a2a2f06b013/5754a/9.png\"\n        srcset=\"/blog/static/6c51f44aa13a2129497a9a2a2f06b013/c26ae/9.png 158w,\n/blog/static/6c51f44aa13a2129497a9a2a2f06b013/6bdcf/9.png 315w,\n/blog/static/6c51f44aa13a2129497a9a2a2f06b013/5754a/9.png 613w\"\n        sizes=\"(max-width: 613px) 100vw, 613px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>1、新建文件<code class=\"language-text\">kernel/shm.c</code>，实现共享内存</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;asm/segment.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/kernel.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/sched.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/mm.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;errno.h></span></span>\r\n\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">_SHM_NUM</span> <span class=\"token expression\"><span class=\"token number\">20</span></span></span>\r\n\r\n<span class=\"token comment\">/* 共享内存结构体 */</span>\r\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">shm_tables</span>\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">int</span> key<span class=\"token punctuation\">;</span>                <span class=\"token comment\">/* 共享内存标识 */</span>\r\n    <span class=\"token keyword\">int</span> size<span class=\"token punctuation\">;</span>                <span class=\"token comment\">/* 共享内存大小 */</span>\r\n    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> page<span class=\"token punctuation\">;</span>        <span class=\"token comment\">/* 共享内存地址 */</span>\r\n<span class=\"token punctuation\">}</span> shm_tables<span class=\"token punctuation\">[</span>_SHM_NUM<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\r\n\r\n\r\n<span class=\"token comment\">/* 获取一块空闲的物理页面来创建共享内存 */</span>\r\n<span class=\"token keyword\">int</span> <span class=\"token function\">sys_shmget</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> key<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> size<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> page<span class=\"token punctuation\">;</span>        <span class=\"token comment\">/* 存放共享内存地址 */</span>\r\n\r\n    <span class=\"token comment\">/* 查看 key 对应的共享内存是否已存在 */</span>\r\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> _SHM_NUM<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> \r\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>shm_tables<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>key <span class=\"token operator\">==</span> key<span class=\"token punctuation\">)</span>\r\n            <span class=\"token keyword\">return</span> i<span class=\"token punctuation\">;</span>\r\n    \r\n    <span class=\"token comment\">/* 内存大小超过一页 */</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">></span> PAGE_SIZE<span class=\"token punctuation\">)</span> \r\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span>EINVAL<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token comment\">/* 获取一块空闲物理内存页面，返回起始物理地址 */</span>\r\n    page <span class=\"token operator\">=</span> <span class=\"token function\">get_free_page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>page<span class=\"token punctuation\">)</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span>ENOMEM<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token comment\">/* 记录到共享内存表中 */</span>\r\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> _SHM_NUM<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>shm_tables<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>key <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n            shm_tables<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>key <span class=\"token operator\">=</span> key<span class=\"token punctuation\">;</span>\r\n            shm_tables<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>size <span class=\"token operator\">=</span> size<span class=\"token punctuation\">;</span>\r\n            shm_tables<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>page <span class=\"token operator\">=</span> page<span class=\"token punctuation\">;</span>\r\n            <span class=\"token keyword\">return</span> i<span class=\"token punctuation\">;</span>\r\n        <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* 共享内存数量已满 */</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token comment\">/* 将指定物理页面映射到当前进程的虚拟内存空间 */</span>\r\n<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span> <span class=\"token function\">sys_shmat</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> shmid<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> data_base<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token comment\">/* 判断共享内存 shmid 是否越界 及 共享内存是否存在 */</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shmid <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> shmid <span class=\"token operator\">>=</span> _SHM_NUM <span class=\"token operator\">||</span> shm_tables<span class=\"token punctuation\">[</span>shmid<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>key <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span>EINVAL<span class=\"token punctuation\">;</span>\r\n    \r\n    <span class=\"token comment\">/* 把物理页面映射到进程的虚拟内存空间，映射到代码段+数据段后，堆栈段前 */</span>\r\n    <span class=\"token function\">put_page</span><span class=\"token punctuation\">(</span>shm_tables<span class=\"token punctuation\">[</span>shmid<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>page<span class=\"token punctuation\">,</span> current<span class=\"token operator\">-></span>brk <span class=\"token operator\">+</span> current<span class=\"token operator\">-></span>start_code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token comment\">/* 修改总长度，brk为代码段和数据段的总长度 */</span>\r\n    current<span class=\"token operator\">-></span>brk <span class=\"token operator\">+=</span> PAGE_SIZE<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>current<span class=\"token operator\">-></span>brk <span class=\"token operator\">-</span> PAGE_SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>对程序中 <code class=\"language-text\">sys_shmat</code> 中的虚拟内存地址进行解释：</p>\n</blockquote>\n<ul>\n<li><code class=\"language-text\">brk</code>为代码段和数据段的总长度，<code class=\"language-text\">brk + start_code </code>即为代码段+数据段结束的位置；<code class=\"language-text\">start_stack</code>为栈的起始地址。</li>\n<li>因此，将物理内存映射到虚拟内存处，<code class=\"language-text\">brk</code>和 <code class=\"language-text\">start_stack</code>之间的空间为栈准备，栈底是闲置的（栈是往低地址方向扩展的），可将共享内存映射到这块空间。</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 614px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/94a677afafd7540f5e1fb7ba3fecb4f1/e9131/10.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.53164556962025%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACUElEQVR42l1T227TQBD1H/AzfAjfwZ8A4qESPPBY3qJWKuoFCXGrIC1pGty4ddr4tokTX5PYjp3ElzjpYcdQq2Kk9Vq7M3Nmz5kRdF2HLMvQVAXM0NHr9dDv3+Hm5prvfURRhM1mA8/zIEkSGDNg6CpEUcQt96U4ihkOh0jTFAK4LRcLMNOCaU9QFAWmwRwDc4wgmOHB7u/veeISjjeBZnqYxwukWY6x7cG2rSqOTLBtG75r45M4wu53DTYPuD7/DPHwHYYnr7GKw8pxu91W+93Axe7H35BVE6wnonX8HuzwJXy1gw0ljKKwQptqHbDWEZS7W9zcXuDs/Ait1jHiOMJ6XWK5XGKVZnBGDIEpY6Ap6KvXaHK/9uUxp6eLJFn8fXJRrGE5BlRdguPYaF418aW9i67xFnES1BWW5Rqe73NfD74/gdSXcNJs4FLZgcKaiOdLCHmRIpxkOOg9w5uLJ+jrImzzGyxzD0xrcH6jKmGWZZVAjDG4rgOLc8f0nxjoDVjDBsbmFfJiA4FQw2CFrz+eo3HwFAaT8Y+uqvKyLKv/PM8r4mezGX9aAsuyOMC8FizjAlWi0GeeJUj3NcSvOhipg9rpscJUIbWF67pY8K6ghHme0S2/39a+QsGRnZmPxYcurBdHkDtdTGZTTCdT3jZBnZg4pEVnVCF1B1X9GLSuMFwlWO1LyHbO4DLef1z5KAy5wnFdHS1KEPJzOjMMo2r4/03YcI7mywTeqYzx3i/4tostfwbx9bBomtrtdjURNFWKokDTtIoCaicCJsEI7A9ABCy+c9IVBwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/94a677afafd7540f5e1fb7ba3fecb4f1/e9131/10.png\"\n        srcset=\"/blog/static/94a677afafd7540f5e1fb7ba3fecb4f1/c26ae/10.png 158w,\n/blog/static/94a677afafd7540f5e1fb7ba3fecb4f1/6bdcf/10.png 315w,\n/blog/static/94a677afafd7540f5e1fb7ba3fecb4f1/e9131/10.png 614w\"\n        sizes=\"(max-width: 614px) 100vw, 614px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>2、修改文件<code class=\"language-text\">include/unistd.h</code>，新增全局函数</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">/* 实验6 */</span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__NR_sem_open</span>   <span class=\"token expression\"><span class=\"token number\">72</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__NR_sem_wait</span>   <span class=\"token expression\"><span class=\"token number\">73</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__NR_sem_post</span>   <span class=\"token expression\"><span class=\"token number\">74</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__NR_sem_unlink</span> <span class=\"token expression\"><span class=\"token number\">75</span></span></span>\r\n<span class=\"token comment\">/* 实验7 */</span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__NR_shmget</span>     <span class=\"token expression\"><span class=\"token number\">76</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__NR_shmat</span>      <span class=\"token expression\"><span class=\"token number\">77</span></span></span></code></pre></div>\n<p>3、修改<code class=\"language-text\">/kernel/system_call.s</code>，需要修改总的系统调用数</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">nr_system_calls <span class=\"token operator\">=</span> <span class=\"token number\">78</span></code></pre></div>\n<p>4、修改<code class=\"language-text\">/include/linux/sys.h</code>，声明全局新增函数</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">/* 实验6 */</span>\r\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> <span class=\"token function\">sys_sem_open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> <span class=\"token function\">sys_sem_wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> <span class=\"token function\">sys_sem_post</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> <span class=\"token function\">sys_sem_unlink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token comment\">/* 实验7 */</span>\r\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> <span class=\"token function\">sys_shmget</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> <span class=\"token function\">sys_shmat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\nfn_ptr sys_call_table<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n<span class=\"token comment\">//...sys_setreuid,sys_setregid,sys_whoami,sys_iam,</span>\r\nsys_sem_open<span class=\"token punctuation\">,</span>sys_sem_wait<span class=\"token punctuation\">,</span>sys_sem_post<span class=\"token punctuation\">,</span>sys_sem_unlink<span class=\"token punctuation\">,</span> <span class=\"token comment\">/* 实验6 */</span>\r\nsys_shmget<span class=\"token punctuation\">,</span> sys_shmat   <span class=\"token comment\">/* 实验7 */</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>5、修改 <code class=\"language-text\">linux-0.11/kernel/Makefile</code>，添加<code class=\"language-text\">sem.c</code>编译规则</p>\n<div class=\"gatsby-highlight\" data-language=\"makefile\"><pre class=\"language-makefile\"><code class=\"language-makefile\">OBJS  <span class=\"token operator\">=</span> sched.o system_call.o traps.o asm.o fork.o \\\r\n\tpanic.o printk.o vsprintf.o sys.o exit.o \\\r\n\tsignal.o mktime.o who.o sem.o\r\n// ...\r\n<span class=\"token comment\">### Dependencies:</span>\r\n<span class=\"token target symbol\">sem.s sem.o</span><span class=\"token punctuation\">:</span> sem.c ../<span class=\"token keyword\">include</span>/linux/sem.h ../<span class=\"token keyword\">include</span>/linux/kernel.h \\\r\n../<span class=\"token keyword\">include</span>/unistd.h</code></pre></div>\n<p>6、实现生产者程序 <code class=\"language-text\">producer.c</code> 和 消费者程序 <code class=\"language-text\">consumer.c</code></p>\n<blockquote>\n<p>为了确保对共享内存操作的互斥，仍需要使用一个信号量在每次读写的时候进行限制；同理，还需要两个信号量保来保证共享内存中缓冲区大小为 10</p>\n</blockquote>\n<p><code class=\"language-text\">producer.c</code></p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__LIBRARY__</span>   <span class=\"token comment\">/* 在第一行添加 */</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/sem.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fcntl.h></span></span>\r\n\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SIZE</span> <span class=\"token expression\"><span class=\"token number\">10</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">M</span> <span class=\"token expression\"><span class=\"token number\">510</span></span></span>\r\n\r\n<span class=\"token comment\">/* add */</span>\r\n<span class=\"token function\">_syscall2</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>sem_open<span class=\"token punctuation\">,</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">,</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">_syscall1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>sem_wait<span class=\"token punctuation\">,</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>sem<span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">_syscall1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>sem_post<span class=\"token punctuation\">,</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>sem<span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">_syscall1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>sem_unlink<span class=\"token punctuation\">,</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">_syscall2</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>shmget<span class=\"token punctuation\">,</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>key<span class=\"token punctuation\">,</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>size<span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">_syscall1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> shmat<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> shmid<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">int</span> shm_id<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>p<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> curr<span class=\"token punctuation\">;</span>\r\n    \r\n    <span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>sem_empty<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>sem_full<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>sem_shm<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/*3个信号量*/</span>\r\n    sem_empty <span class=\"token operator\">=</span> <span class=\"token function\">sem_open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"empty\"</span><span class=\"token punctuation\">,</span> SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    sem_full <span class=\"token operator\">=</span> <span class=\"token function\">sem_open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"full\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    sem_shm <span class=\"token operator\">=</span> <span class=\"token function\">sem_open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"shm\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    shm_id <span class=\"token operator\">=</span> <span class=\"token function\">shmget</span><span class=\"token punctuation\">(</span><span class=\"token number\">2521</span><span class=\"token punctuation\">,</span> SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">/* 获取一块空闲的物理页面来创建共享内存 */</span>\r\n    p <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">shmat</span><span class=\"token punctuation\">(</span>shm_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">/* 将指定物理页面映射到当前进程的虚拟内存空间 */</span>\r\n\r\n    <span class=\"token comment\">/*生产多少个产品就循环几次*/</span>\r\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>count <span class=\"token operator\">&lt;=</span> M<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token comment\">/*empty大于0,才能生产*/</span>\r\n        <span class=\"token function\">sem_wait</span><span class=\"token punctuation\">(</span>sem_empty<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">/* empty-- */</span>\r\n        <span class=\"token function\">sem_wait</span><span class=\"token punctuation\">(</span>sem_shm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">/* mutex-- */</span>\r\n\r\n        <span class=\"token comment\">/*从上次位置继续向文件缓冲区写入一个字符*/</span>\r\n        curr <span class=\"token operator\">=</span> count <span class=\"token operator\">%</span> SIZE<span class=\"token punctuation\">;</span>    <span class=\"token comment\">/*更新写入缓冲区位置，保证在0-9之间，缓冲区最大为10*/</span>\r\n        <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">+</span> curr<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> count<span class=\"token punctuation\">;</span>\r\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Producer: %d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">+</span> curr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token function\">fflush</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdout</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n        <span class=\"token function\">sem_post</span><span class=\"token punctuation\">(</span>sem_shm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">/* mutex++ */</span>\r\n        <span class=\"token function\">sem_post</span><span class=\"token punctuation\">(</span>sem_full<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">/* full++，唤醒消费者线程 */</span>\r\n        count<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"producer end.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">fflush</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdout</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">consumer.c</code></p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__LIBRARY__</span>   <span class=\"token comment\">/* 在第一行添加 */</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/sem.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fcntl.h></span></span>\r\n\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SIZE</span> <span class=\"token expression\"><span class=\"token number\">10</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">M</span> <span class=\"token expression\"><span class=\"token number\">510</span></span></span>\r\n\r\n<span class=\"token comment\">/* add */</span>\r\n<span class=\"token function\">_syscall2</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>sem_open<span class=\"token punctuation\">,</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">,</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">_syscall1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>sem_wait<span class=\"token punctuation\">,</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>sem<span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">_syscall1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>sem_post<span class=\"token punctuation\">,</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>sem<span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">_syscall1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>sem_unlink<span class=\"token punctuation\">,</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">_syscall2</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>shmget<span class=\"token punctuation\">,</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>key<span class=\"token punctuation\">,</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>size<span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">_syscall1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> shmat<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> shmid<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">int</span> shm_id<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>p<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> curr<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>sem_empty<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>sem_full<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>sem_shm<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/*3个信号量*/</span>\r\n    sem_empty <span class=\"token operator\">=</span> <span class=\"token function\">sem_open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"empty\"</span><span class=\"token punctuation\">,</span> SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    sem_full <span class=\"token operator\">=</span> <span class=\"token function\">sem_open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"full\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    sem_shm <span class=\"token operator\">=</span> <span class=\"token function\">sem_open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"shm\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    shm_id <span class=\"token operator\">=</span> <span class=\"token function\">shmget</span><span class=\"token punctuation\">(</span><span class=\"token number\">2521</span><span class=\"token punctuation\">,</span> SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">/* 获取一块空闲的物理页面来创建共享内存 */</span>\r\n    p <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">shmat</span><span class=\"token punctuation\">(</span>shm_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">/* 将指定物理页面映射到当前进程的虚拟内存空间 */</span>\r\n\r\n    <span class=\"token comment\">/*生产多少个产品就循环几次*/</span>\r\n    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">&lt;=</span> M<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token comment\">/* full大于0，才能消费 */</span>\r\n        <span class=\"token function\">sem_wait</span><span class=\"token punctuation\">(</span>sem_full<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/* full-- */</span>\r\n        <span class=\"token function\">sem_wait</span><span class=\"token punctuation\">(</span>sem_shm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* mutex-- */</span>\r\n\r\n        <span class=\"token comment\">/*从上次位置继续向文件缓冲区写入一个字符*/</span>\r\n        curr <span class=\"token operator\">=</span> count <span class=\"token operator\">%</span> SIZE<span class=\"token punctuation\">;</span>    <span class=\"token comment\">/*更新写入缓冲区位置，保证在0-9之间，缓冲区最大为10*/</span>\r\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d:%d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">getpid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">+</span> curr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token function\">fflush</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdout</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n        <span class=\"token function\">sem_post</span><span class=\"token punctuation\">(</span>sem_shm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">/* mutex++ */</span>\r\n        <span class=\"token function\">sem_post</span><span class=\"token punctuation\">(</span>sem_empty<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">/* empty++，唤醒生产者进程 */</span>\r\n        count<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"consumer end.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">fflush</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdout</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token comment\">/*释放信号量*/</span>\r\n    <span class=\"token function\">sem_unlink</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"empty\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">sem_unlink</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"full\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">sem_unlink</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"shm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>三、在linux0.11环境下编译运行</h2>\n<ol>\n<li>将已经修改的<code class=\"language-text\">consumer.c</code>、<code class=\"language-text\">producer.c</code> 和 <code class=\"language-text\">unistd.h</code>、<code class=\"language-text\">sem.h</code>（详见Lab6）文件拷贝到linux-0.11系统中</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> oslab_Lab6\r\n<span class=\"token function\">sudo</span> ./mount-hdc\r\n<span class=\"token function\">cp</span> ./consumer.c ./hdc/usr/root/\r\n<span class=\"token function\">cp</span> ./producer.c ./hdc/usr/root/\r\n<span class=\"token function\">cp</span> ./linux-0.11/include/unistd.h ./hdc/usr/include/ \r\n<span class=\"token function\">cp</span> ./linux-0.11/include/linux/sem.h ./hdc/usr/include/linux/\r\n<span class=\"token function\">sudo</span> <span class=\"token function\">umount</span> hdc</code></pre></div>\n<ol start=\"2\">\n<li>编译及运行Bochs</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> oslab_Lab6/linux-0.11\r\n<span class=\"token function\">make</span> all\r\n<span class=\"token punctuation\">..</span>/run</code></pre></div>\n<ol start=\"3\">\n<li>在linux0.11的Bochs中编译生产者-消费者程序</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">gcc <span class=\"token parameter variable\">-o</span> producer producer.c\r\ngcc <span class=\"token parameter variable\">-o</span> consumer consumer.c\r\n<span class=\"token function\">sync</span>\r\n./producer <span class=\"token operator\">></span> p.txt <span class=\"token operator\">&amp;</span>\r\n./consumer <span class=\"token operator\">></span> c.txt</code></pre></div>\n<blockquote>\n<p><code class=\"language-text\">&amp;</code> 表示使用终端的后台运行功能。</p>\n</blockquote>\n<ol start=\"4\">\n<li>在Ubuntu中挂载<code class=\"language-text\">hdc</code>，将linux0.11输出的<code class=\"language-text\">1.txt</code>文件移动到Ubuntu中</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo ./mount-hdc\r\ncd /hdc/usr/root/\r\nsudo cp ./p.txt ../../..\r\nsudo cp ./c.txt ../../..</code></pre></div>\n<p>打开<code class=\"language-text\">p.txt</code> 和 <code class=\"language-text\">c.txt</code> 文件即可见到输出如下：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 274px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/bcc3c9b4424d491c90ab77a76306804c/d3fa7/11.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 111.39240506329114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAACgklEQVR42o1V2XLaQBDk/z8myQNVju3CDxwCIQ7dB7o4xOVKHjBFYiSgM7MyqRCwvVRtAYLt7Znu6a18+/oF1WoV9UYDiqLg4eEed9/vUKvV0Ov3MQoCPD3VcP/4iDCMkKYpkiS5WHEcI8sy1Ot1VNROWzycTjNMJlO4rgvX8xBFEVbrNfI8x8j3MBgMURyOuPU6HsvnjFNpNRvoExM+JY5TmIYOwzDguR6y+QKvv3/RIQ4cx0VeFDidTgLg33U4HAQgk6i0lRZ6Wk8ApukYpmnSsuD7PubLFfb7VwJ3YDsODkcJhm2lKUBi+pKOx7AskxYBUu/myyUB7hF4DjodlRgePgdU2y2o3S4iZvgf4OKNIZes6wb1UAJQadZpgyfAElLwouTFEkWRi5KZoZQo7VZDMGKwqx4yYL6HTb8bhvl348cMCZD/fGZ40UMBmMMlQSzbJjUlRbFth1S+IcoboENgOh0qqXJDmDYMw7KH5EEu2/f8a0AZhiwK9yxNE2EdNjW3wKNpyRYLMSm2bYkxlBJFadVhEKPzjL7HcDDUJRmSKGwJnpQkea9kC6Zly/WQAQMSYDyZlCpf2aYEVLuavA+HwyHGZ9vcBLRFW+QYkiiK0hYqsyi6XqYNx9iM0oYB+RCLrHU8nuR8qFPDP+qhSyW3KHylwkHraTQJFoVDRH2cClNbJEAQjEQ4nEvmzJRSWVVVskxcBizbxjREv84+5PiKAh9D3cQ+Lz4H7HbJMpS0s1lG18BUlCxGj0RZrZ/x8rIRV0AwCimtS4BzavM7r4vE1rQuAYYUUS5tGhHDUhQu+/nHT8wmKbTegK6DudhY0DXArDebDbbbLXa7nfjM7yzoH4cgXNbF2VoXAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/bcc3c9b4424d491c90ab77a76306804c/d3fa7/11.png\"\n        srcset=\"/blog/static/bcc3c9b4424d491c90ab77a76306804c/c26ae/11.png 158w,\n/blog/static/bcc3c9b4424d491c90ab77a76306804c/d3fa7/11.png 274w\"\n        sizes=\"(max-width: 274px) 100vw, 274px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\r\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 187px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/7d22daebb95a521d3b84f24eaf357f77/47fe2/12.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 129.1139240506329%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAAsTAAALEwEAmpwYAAADhklEQVR42pVVa2/aWBTk//+IVdpq2zSqdumGEBIgUDA2jxhCbPzAYMBgjMEY8+w2r9lzb/Jhpa26xtKVH9jD3DNz5iS+nJ3i5P17fPj9I/K5HM7OPiObv0Eul8eHk99w8u4d8oUS2u07yLKMZrP5y5Uw1DYEqYqyIMH3XCiKgtFojF7fhlyvon2vIAjXYMfLywv+70g4QxtqR8PU87BarTAY2FgslvDnc5h6B/eKilW04S8/PT3h+fn5lyvRaki4KX7joJPJBFVJwpAz7KOYv0b+pgB3FsRnqKn3uG22YJgW/JmHjqoQWx+O46Ap30LVdDw8PCDukTA1BVK9Ad0wsfBnVEOVauhgRIByo4pWW8Fuf3hjGAPQMjXctu7Q7fawmPt0NjDz55hOp2jJDWi6hvX2EH/LaruJ2q0MXTcxnThcetedEssR6pIImf5sszsC8E6uoSSIuCN7uGMGKNN2XfRJFKFURK1Ww3x5hG1GtoWOZsC0egjmMw7kTT14Mx96RyXFHWy2+/iAHdpysSxCVTVeQ0VpY+J6BDSCVClBEivwgyMYdo0OFPJg3x5iRp2iquqbKC7uqd36/R6iYxg2JAEXmWuUiOV0Mka1KnJwg2yUu7pEsVRGcEwNPZe6wrZh9WxE4RLOeEyttyCQJYZ2Hy7Vc3/4/goYx9hyXUQmm+cqT90JGvUaF8Lq9ZG/uuDJMz8mHOxeF7rZRRhGCJcB+VFHEITwqWu6hk5bNxC+hUMswGq5gGTqAsm/UnCGA1SEMrpkIU3TkD7/CkGsUqfs4gMuyHusbpPJFJt1ROp6xHZFkRXBJZGCZchjKXY41CpFYpjGdfaGMxTJd0xlFhaX53/ij2QSw8k8PsMhBSoTwSXfLYMAlkX1XEVk8jn6PYvEsf7VyzEY1qsS9bKATCaLgd2DQDU0SCQWuKnkF6TSaYy9RXyGTNmZ7xOrFXbbLY/+aL3GerPhjAP6/fvfP46oIUVURZTQNU0MhkMUCnlucqayWKEuSp1jMPZ+yvBnjBNjZ0Rh4PJ5stttaVBFWBPDDTFkiw2u/eHAxwD7/PHxka+IXMDO/wEUKVEKJYFmbpNPuTJlYOryGmmqXTadQuYqi4+npzSbv3FbFQs3yFym8enTKdnN5cCsVZfUquw6werGLhirLV2/stu+sgtD/my329Fc2XO2S3q2oXci2gm7D+megbHF7v8BIJCWlLs5DccAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/7d22daebb95a521d3b84f24eaf357f77/47fe2/12.png\"\n        srcset=\"/blog/static/7d22daebb95a521d3b84f24eaf357f77/c26ae/12.png 158w,\n/blog/static/7d22daebb95a521d3b84f24eaf357f77/47fe2/12.png 187w\"\n        sizes=\"(max-width: 187px) 100vw, 187px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>","frontmatter":{"title":"【哈工大_操作系统实验】Lab7 地址映射与共享","date":"October 15, 2024","description":"本文将介绍哈工大操作系统实验课Lab7 地址映射与共享"}},"previous":{"fields":{"slug":"/015_HIT_OS_Lab6/"},"frontmatter":{"title":"【哈工大_操作系统实验】Lab6 信号量的实现和应用"}},"next":{"fields":{"slug":"/017_HIT_OS_Lab8/"},"frontmatter":{"title":"【哈工大_操作系统实验】Lab8 终端设备的控制"}}},"pageContext":{"id":"6f3e8248-ac12-5c84-862d-01d2e442249c","previousPostId":"a3234939-ea6b-51d3-b87c-5b00bf1a98cc","nextPostId":"d1f5cbae-a781-5527-9a6a-49f5dd153691"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}