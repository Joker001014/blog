{"componentChunkName":"component---src-templates-blog-post-js","path":"/015_HIT_OS_Lab6/","result":{"data":{"site":{"siteMetadata":{"title":"JokerDebug"}},"markdownRemark":{"id":"a3234939-ea6b-51d3-b87c-5b00bf1a98cc","excerpt":"Github代码仓库链接 本节将更新哈工大《操作系统》课程第六个 Lab 实验 信号量的实现和应用。按照实验书要求，介绍了非常详细的实验操作流程，并提供了超级无敌详细的代码注释。 实验目的： 加深对进程同步与互斥概念的认识； 综掌握信号量的使用，并应用它解决生产者——消费者问题； 掌握信号量的实现原理。 实验任务：…","html":"<p><a href=\"https://github.com/Joker001014/HIT-OSlab\">Github代码仓库链接</a></p>\n<p>本节将更新哈工大《操作系统》课程第六个 Lab 实验 <strong>信号量的实现和应用</strong>。按照实验书要求，介绍了非常详细的实验操作流程，并提供了超级无敌详细的代码注释。</p>\n<p><strong>实验目的：</strong></p>\n<blockquote>\n<ul>\n<li>加深对进程同步与互斥概念的认识；</li>\n<li>综掌握信号量的使用，并应用它解决生产者——消费者问题；</li>\n<li>掌握信号量的实现原理。</li>\n</ul>\n</blockquote>\n<p><strong>实验任务：</strong></p>\n<blockquote>\n<p>1、在 Ubuntu 下编写程序，用信号量解决生产者——消费者问题；\r\n2、在 0.11 中实现信号量，用生产者—消费者程序检验之。</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>文件名</th>\n<th>介绍</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>hit-操作系统实验指导书.pdf</td>\n<td>哈工大OS实验指导书</td>\n</tr>\n<tr>\n<td>Linux内核完全注释(修正版v3.0).pdf</td>\n<td>赵博士对Linux v0.11 OS进行了详细全面的注释和说明</td>\n</tr>\n<tr>\n<td>file1615.pdf</td>\n<td>BIOS 涉及的中断数据手册</td>\n</tr>\n<tr>\n<td>hit-oslab-linux-20110823.tar.gz</td>\n<td>hit-oslab 实验环境</td>\n</tr>\n<tr>\n<td>gcc-3.4-ubuntu.tar.gz</td>\n<td>Linux v0.11 所使用的编译器</td>\n</tr>\n<tr>\n<td><a href=\"https://joker001014.github.io/blog/019_HIT_OS_Bochs\">Bochs 汇编级调试指令</a></td>\n<td>bochs 基本调试指令大全</td>\n</tr>\n<tr>\n<td><a href=\"https://blog.csdn.net/yueyueniaolzp/article/details/82178954\">最全ASCII码对照表0-255</a></td>\n<td>屏幕输出字符对照的 ASCII 码</td>\n</tr>\n<tr>\n<td><a href=\"https://blog.csdn.net/weixin_53159274/article/details/138074386?spm=1001.2014.3001.5501\">x86_64 常用寄存器大全</a></td>\n<td>x86_64 常用寄存器大全</td>\n</tr>\n</tbody>\n</table>\n<h3>一、编写生产者-消费者模型</h3>\n<p>1、在编写生产者-消费者模型之前，先进行一些知识准备：</p>\n<blockquote>\n<p><code class=\"language-text\">lseek() </code>函数可以改变文件的文件偏移量，所有打开的文件都有一个当前文件偏移量，用于表明文件开始处到文件当前位置的字节数。成功返回新的偏移量，失败返回-1。</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token class-name\">off_t</span> <span class=\"token function\">lseek</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> filedes<span class=\"token punctuation\">,</span> <span class=\"token class-name\">off_t</span> offset<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> whence<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token comment\">// 参数 filedes：  文件描述符</span>\r\n<span class=\"token comment\">// 参数 offset：   位移量</span>\r\n<span class=\"token comment\">// 参数 whence：   指定初始位置</span>\r\n\t<span class=\"token comment\">// \tSEEK_SET 将读写位置指向文件头后再增加offset个位移量。</span>\r\n\t<span class=\"token comment\">//\tSEEK_CUR 以目前的读写位置往后增加offset个位移量。</span>\r\n\t<span class=\"token comment\">//\tSEEK_END 将读写位置指向文件尾后再增加offset个位移量。</span></code></pre></div>\n<p>2、实现生产者、消费者模型，编写<code class=\"language-text\">pc.c</code>文件：</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/types.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fcntl.h></span>          </span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/stat.h></span>        </span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;semaphore.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/types.h></span>  </span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/wait.h></span></span>\r\n\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">M</span> <span class=\"token expression\"><span class=\"token number\">530</span>    \t\t</span><span class=\"token comment\">/*打出数字总数*/</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">N</span> <span class=\"token expression\"><span class=\"token number\">5</span>       \t\t</span><span class=\"token comment\">/*消费者进程数*/</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">BUFSIZE</span> <span class=\"token expression\"><span class=\"token number\">10</span>      </span><span class=\"token comment\">/*缓冲区大小*/</span></span>\r\n\r\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n\t<span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>empty<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>full<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>mutex<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/*3个信号量*/</span>\r\n\t<span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">;</span>                       <span class=\"token comment\">/*共享缓冲区文件描述符*/</span>\r\n    <span class=\"token keyword\">int</span>  i<span class=\"token punctuation\">,</span>j<span class=\"token punctuation\">,</span>k<span class=\"token punctuation\">,</span>child<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span>  data<span class=\"token punctuation\">;</span>                    <span class=\"token comment\">/*写入的数据*/</span>\r\n    <span class=\"token class-name\">pid_t</span> pid<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span>  buf_out <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>             <span class=\"token comment\">/*记录上次从缓冲区读取位置*/</span>\r\n    <span class=\"token keyword\">int</span>  buf_in <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>              <span class=\"token comment\">/*记录上次写入缓冲区位置*/</span>\r\n\t<span class=\"token comment\">/*创建信号量*/</span>\r\n\tempty <span class=\"token operator\">=</span> <span class=\"token function\">sem_open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"empty\"</span><span class=\"token punctuation\">,</span> O_CREAT<span class=\"token operator\">|</span>O_EXCL<span class=\"token punctuation\">,</span> <span class=\"token number\">0644</span><span class=\"token punctuation\">,</span> BUFSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/*剩余资源,初始化为size*/</span>\r\n    full <span class=\"token operator\">=</span> <span class=\"token function\">sem_open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"full\"</span><span class=\"token punctuation\">,</span> O_CREAT<span class=\"token operator\">|</span>O_EXCL<span class=\"token punctuation\">,</span> <span class=\"token number\">0644</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">/*已生产资源，初始化为0*/</span>\r\n\tmutex <span class=\"token operator\">=</span> <span class=\"token function\">sem_open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mutex\"</span><span class=\"token punctuation\">,</span> O_CREAT<span class=\"token operator\">|</span>O_EXCL<span class=\"token punctuation\">,</span> <span class=\"token number\">0644</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">/*互斥量，初始化为1*/</span>\r\n    <span class=\"token comment\">/* 在文件中存储buf_out（因此生产者只有一个进程，所以buf_in不用存在文件中）*/</span>\r\n    fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"buffer.txt\"</span><span class=\"token punctuation\">,</span> O_CREAT<span class=\"token operator\">|</span>O_TRUNC<span class=\"token operator\">|</span>O_RDWR<span class=\"token punctuation\">,</span><span class=\"token number\">0666</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \r\n    <span class=\"token function\">lseek</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span>BUFSIZE<span class=\"token operator\">*</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token constant\">SEEK_SET</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">/*修改地址偏移在10个数字之后，即40字节位置*/</span>\r\n    <span class=\"token function\">write</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>buf_out<span class=\"token punctuation\">,</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">/*将上次读取位置buf_out存入buffer后的一个位置,每次从该位置获取上次位置，以便子进程之间通信*/</span>\r\n    \r\n    <span class=\"token comment\">/*生产者进程*/</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pid<span class=\"token operator\">=</span><span class=\"token function\">fork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">==</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"I'm producer. pid = %d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">getpid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\t<span class=\"token comment\">/*生产多少个产品就循环几次*/</span>\r\n        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> M<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">{</span>\r\n\t\t\t<span class=\"token comment\">/*empty大于0,才能生产*/</span>\r\n            <span class=\"token function\">sem_wait</span><span class=\"token punctuation\">(</span>empty<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* empty-- */</span>\r\n            <span class=\"token function\">sem_wait</span><span class=\"token punctuation\">(</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* mutex-- */</span>\r\n            \r\n            <span class=\"token comment\">/*从上次位置继续向文件缓冲区写入一个字符*/</span>\r\n            <span class=\"token function\">lseek</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> buf_in<span class=\"token operator\">*</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">SEEK_SET</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \r\n            <span class=\"token function\">write</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>i<span class=\"token punctuation\">,</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \r\n            <span class=\"token comment\">/*更新写入缓冲区位置，保证在0-9之间，缓冲区最大为10*/</span>\r\n            buf_in <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>buf_in <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> BUFSIZE<span class=\"token punctuation\">;</span>\r\n            \r\n            <span class=\"token function\">sem_post</span><span class=\"token punctuation\">(</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* mutex++ */</span>\r\n            <span class=\"token function\">sem_post</span><span class=\"token punctuation\">(</span>full<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">/* full++，唤醒消费者线程 */</span>\r\n        <span class=\"token punctuation\">}</span>\r\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"producer end.\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token function\">fflush</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdout</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">/*确保将输出立刻输出到标准输出。*/</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\t<span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>pid <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Fail to fork!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    \r\n\t<span class=\"token comment\">/*消费者进程*/</span>\r\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> N <span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span> <span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pid<span class=\"token operator\">=</span><span class=\"token function\">fork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">==</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">{</span>\r\n\t        <span class=\"token comment\">/* 每个进程读取 M/N 个数字 */</span>\r\n\t\t\t<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span> k <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> k <span class=\"token operator\">&lt;</span> M<span class=\"token operator\">/</span>N<span class=\"token punctuation\">;</span> k<span class=\"token operator\">++</span> <span class=\"token punctuation\">)</span>\r\n            <span class=\"token punctuation\">{</span>\r\n\t            <span class=\"token comment\">/* full大于0，才能消费 */</span>\r\n                <span class=\"token function\">sem_wait</span><span class=\"token punctuation\">(</span>full<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* full-- */</span>\r\n                <span class=\"token function\">sem_wait</span><span class=\"token punctuation\">(</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/* mutex-- */</span>\r\n\t\t\t\t\r\n                <span class=\"token comment\">/*从文件第11个位置获得上次读取位置*/</span>\r\n                <span class=\"token function\">lseek</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span>BUFSIZE<span class=\"token operator\">*</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token constant\">SEEK_SET</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                <span class=\"token function\">read</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>buf_out<span class=\"token punctuation\">,</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                <span class=\"token comment\">/*从上次读取位置继续读取数据*/</span>\r\n                <span class=\"token function\">lseek</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span>buf_out<span class=\"token operator\">*</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token constant\">SEEK_SET</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                <span class=\"token function\">read</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>data<span class=\"token punctuation\">,</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                <span class=\"token comment\">/*在文件第11个位置写入下次应读取位置*/</span>\r\n                buf_out <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>buf_out <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> BUFSIZE<span class=\"token punctuation\">;</span>\r\n                <span class=\"token function\">lseek</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span>BUFSIZE<span class=\"token operator\">*</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token constant\">SEEK_SET</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                <span class=\"token function\">write</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>buf_out<span class=\"token punctuation\">,</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n                <span class=\"token function\">sem_post</span><span class=\"token punctuation\">(</span>mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* mutex++ */</span>\r\n                <span class=\"token function\">sem_post</span><span class=\"token punctuation\">(</span>empty<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* empty++，唤醒生产者进程 */</span>\r\n                <span class=\"token comment\">/*消费资源*/</span>\r\n                <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d:  %d\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">getpid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                <span class=\"token function\">fflush</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdout</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            <span class=\"token punctuation\">}</span>\r\n\t\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"child-%d: pid = %d end.\\n\"</span><span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">,</span> <span class=\"token function\">getpid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n            <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token punctuation\">}</span>\r\n\t\t<span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>pid<span class=\"token operator\">&lt;</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\r\n\t\t<span class=\"token punctuation\">{</span>\r\n\t\t\t<span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Fail to fork!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n\t\t<span class=\"token punctuation\">}</span>\r\n\t<span class=\"token punctuation\">}</span>\r\n\t<span class=\"token comment\">/*回收线程资源*/</span>\r\n    child <span class=\"token operator\">=</span> N <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>child<span class=\"token operator\">--</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token comment\">/*释放信号量*/</span>\r\n    <span class=\"token function\">sem_unlink</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"full\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">sem_unlink</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"empty\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">sem_unlink</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mutex\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token comment\">/*释放文件资源*/</span>\r\n    <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>3、在Ubuntu下编译执行</p>\n<ul>\n<li><strong>注意</strong>：此处代码头文件使用的是Ubuntu系统下的<code class=\"language-text\">semaphore.h</code>中的信号量，故无需下文定义的信号量即可编译通过。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">gcc -o pc pc.c -lpthread\r\n./pc > 1.txt</code></pre></div>\n<p>打开<code class=\"language-text\">1.txt</code>文件即可见到输出如下：\r\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 170px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/7da89b7b4f6eb5770eef03138c27413e/04472/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 217.08860759493672%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/7da89b7b4f6eb5770eef03138c27413e/04472/1.png\"\n        srcset=\"/blog/static/7da89b7b4f6eb5770eef03138c27413e/c26ae/1.png 158w,\n/blog/static/7da89b7b4f6eb5770eef03138c27413e/04472/1.png 170w\"\n        sizes=\"(max-width: 170px) 100vw, 170px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 301px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/d975f1e247d87b1dddf4fc811bcb5b78/fb933/2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 95.56962025316456%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACzUlEQVR42pVUiW7aUBDk/7+qzdFgbEPAxhe+bUw4GlKuBDBMZx+HUqlqqCXLGPnNzs7OTmMQ+HC9AHkWw7YsfPt+B03TEAwiyBWGITqdDj4+tur9eDziX1fD91z0XR9ZGsN1XeiGiX7fRpoX6oMsy+B5Hra7vaDhcDhcDwu4ug/Ha6FGHIWw7T7G4zGqaoiiKDAYDPDc7cJ1HBbxsF6vMZ1O0e60MawqrFYr5HmGtqmjpfNutTB/W5wAXdeB4/mIowhpmsA0Tfi+jzCKUZUFdL2FcjjCbl9jtVzyuVdsttstZXjHZrNRBeu6PgEmSQSXAAmZemzfYMu9noW8KFHvd2QbsECAfX3ALVejb1vodAmQRgTq4u7+QbEMwtNQfOpnGgaZnQCp1vn5ScNPg1IaJlmO0bBQhzVNV4BRnKoPkiRW9/42gmgEPttsP6PIUzhOH09NjUx7qohcMiAZ2s0tRyEPOB5KTu0CaLDFKE7ODBOlo7KNahNf+dCh99rUMFGAjz+elJHDM+AgCBTD7XZ3m7HjOIIfhMoiYmitpSvAJM2uDH1u0+7C8KuWfd+D1XeQ0T42J353/6i8J0UuDLvd3n9oyCnLLlecssPN0Oh62ZI0K64M5f/bNeSULdtBkSUMh57S0DQN+jBWHwQ0vexyfTieXPiH9/7iQ0mbntVXtpGWHx4e0Ww2r2kjLjDoy49bhxIxnjyulgCG9JzssQTAy8sEr6+virW8L7mvI4ZHl3K0GG9m5xllWSKipWwOsz7XaYQhRe/ZKIv8pKHWgiXG5pTreq+2R2Jt8/6BHQNBkmbJkFjyueeuSzjIf4dLfEnLFltOaR+HlWTtBDhJ8zOgy/ZDvLPlNQ9OzjE3ZpwtFgssfv3CbDZTLjgwcRpJHDNEc+ZgDvktWzGUA5MJD1aQ8KiqEebzN5WB0rJp6HRCjxLRIVwGccV09hNv8zl+A1MWjCpdX4PJAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/d975f1e247d87b1dddf4fc811bcb5b78/fb933/2.png\"\n        srcset=\"/blog/static/d975f1e247d87b1dddf4fc811bcb5b78/c26ae/2.png 158w,\n/blog/static/d975f1e247d87b1dddf4fc811bcb5b78/fb933/2.png 301w\"\n        sizes=\"(max-width: 301px) 100vw, 301px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>二、信号量的实现</h3>\n<p>1、新建头文件<code class=\"language-text\">include/linux/sem.h</code>，定义信号量的数据结构</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifndef</span> <span class=\"token expression\">_SEM_H</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">_SEM_H</span></span>\r\n\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/sched.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SEMTABLE_LEN</span>    <span class=\"token expression\"><span class=\"token number\">20</span>   </span><span class=\"token comment\">/* 信号量个数 */</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SEM_NAME_LEN</span>    <span class=\"token expression\"><span class=\"token number\">20</span>   </span><span class=\"token comment\">/* 信号量名字长 */</span></span>\r\n\r\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">semaphore</span>\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">char</span> name<span class=\"token punctuation\">[</span>SEM_NAME_LEN<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">/* 信号名 */</span>\r\n    <span class=\"token keyword\">int</span> value<span class=\"token punctuation\">;</span>                 <span class=\"token comment\">/* 信号值 */</span>\r\n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">task_struct</span> <span class=\"token operator\">*</span>queue<span class=\"token punctuation\">;</span> <span class=\"token comment\">/* 信号队列 */</span>\r\n<span class=\"token punctuation\">}</span> <span class=\"token class-name\">sem_t</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token keyword\">extern</span> <span class=\"token class-name\">sem_t</span> semtable<span class=\"token punctuation\">[</span>SEMTABLE_LEN<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* 声明全局 */</span>\r\n\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></code></pre></div>\n<p>2、新建文件<code class=\"language-text\">kernel/sem.c</code>，实现信号量</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/sem.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/sched.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;asm/segment.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/tty.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/kernel.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/fdreg.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;asm/system.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;asm/io.h></span></span>\r\n<span class=\"token comment\">//#include &lt;string.h></span>\r\n\r\n<span class=\"token class-name\">sem_t</span> semtable<span class=\"token punctuation\">[</span>SEMTABLE_LEN<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 已创建信号量表</span>\r\n<span class=\"token keyword\">int</span> cnt <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>                   <span class=\"token comment\">// 记录已创建信号量个数</span>\r\n\r\n<span class=\"token comment\">// 创建一个信号量</span>\r\n<span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span><span class=\"token function\">sys_sem_open</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>name<span class=\"token punctuation\">,</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> value<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">char</span> kernelname<span class=\"token punctuation\">[</span><span class=\"token number\">100</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">/* 应该足够大了 */</span>\r\n    <span class=\"token keyword\">int</span> isExist <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> name_cnt<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token comment\">// 计算信号量名字长度，需要通过get_fs_byte从用户空间获取数据</span>\r\n    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span> <span class=\"token function\">get_fs_byte</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">+</span>name_cnt<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token char\">'\\0'</span><span class=\"token punctuation\">)</span>\r\n\t    name_cnt<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\r\n\t<span class=\"token comment\">// 大于则退出</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>name_cnt<span class=\"token operator\">></span>SEM_NAME_LEN<span class=\"token punctuation\">)</span>\r\n\t    <span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\r\n\t<span class=\"token comment\">// 将信号量名字从用户态复制到内核态，存入kernelname</span>\r\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>name_cnt<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\r\n\t    kernelname<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token function\">get_fs_byte</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">+</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> name_len <span class=\"token operator\">=</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>kernelname<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> sem_name_len <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>p <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 信号量结构体</span>\r\n    <span class=\"token comment\">// 判断信号量是否已存在</span>\r\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>cnt<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n\t    <span class=\"token comment\">// 先比较长度</span>\r\n        sem_name_len <span class=\"token operator\">=</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>semtable<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sem_name_len <span class=\"token operator\">==</span> name_len<span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">{</span>\r\n\t\t    <span class=\"token comment\">// 再比较名字是否一致</span>\r\n\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">!</span><span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span>kernelname<span class=\"token punctuation\">,</span>semtable<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span>\r\n\t\t\t<span class=\"token punctuation\">{</span>\r\n\t\t\t\t<span class=\"token comment\">// 一致则退出</span>\r\n\t\t\t\tisExist <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\r\n\t\t\t<span class=\"token punctuation\">}</span>\r\n        <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token comment\">// 若已存在，则赋值下文返回</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>isExist <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n        p <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>semtable<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">//printk(\"find previous name!\\n\");</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">else</span>   <span class=\"token comment\">// 不存在，则新建</span>\r\n    <span class=\"token punctuation\">{</span>\r\n        i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// 赋值信号名</span>\r\n        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>name_len<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">{</span>\r\n            semtable<span class=\"token punctuation\">[</span>cnt<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>kernelname<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token punctuation\">}</span>\r\n        <span class=\"token comment\">// 赋值信号值</span>\r\n        semtable<span class=\"token punctuation\">[</span>cnt<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// 往信号量表cnt位置记录</span>\r\n        p<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>semtable<span class=\"token punctuation\">[</span>cnt<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n         <span class=\"token comment\">//printk(\"creat name!\\n\");</span>\r\n        cnt<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\r\n     <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">return</span> p<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token comment\">// 信号量P原子操作</span>\r\n<span class=\"token keyword\">int</span> <span class=\"token function\">sys_sem_wait</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>sem<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n\t<span class=\"token comment\">// 关中断，阻止调度，实现临界区保护</span>\r\n    <span class=\"token function\">cli</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \r\n    <span class=\"token comment\">// 使得所有小于0的进程阻塞（生产者没有缓冲可用empty&lt;=0，则进入睡眠）</span>\r\n    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span> sem<span class=\"token operator\">-></span>value <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span>        \r\n        <span class=\"token function\">sleep_on</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>sem<span class=\"token operator\">-></span>queue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 睡眠当前进程</span>\r\n    sem<span class=\"token operator\">-></span>value<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token comment\">// 开中断</span>\r\n    <span class=\"token function\">sti</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token comment\">// 信号量V原子操作</span>\r\n<span class=\"token keyword\">int</span> <span class=\"token function\">sys_sem_post</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>sem<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n\t<span class=\"token comment\">// 关中断，阻止调度，实现临界区保护</span>\r\n    <span class=\"token function\">cli</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    sem<span class=\"token operator\">-></span>value<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token comment\">// 加完后小于等于1，说明加之前是没有可消费的，则唤醒一个进程</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span>sem<span class=\"token operator\">-></span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token function\">wake_up</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>sem<span class=\"token operator\">-></span>queue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\t<span class=\"token comment\">// 开中断</span>\r\n    <span class=\"token function\">sti</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token comment\">// 删除信号量</span>\r\n<span class=\"token keyword\">int</span> <span class=\"token function\">sys_sem_unlink</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>name<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">char</span> kernelname<span class=\"token punctuation\">[</span><span class=\"token number\">100</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">/* 应该足够大了 */</span>\r\n    <span class=\"token keyword\">int</span> isExist <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> name_cnt<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token comment\">// 计算信号量名字长度，需要通过get_fs_byte从用户空间获取数据</span>\r\n    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span> <span class=\"token function\">get_fs_byte</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">+</span>name_cnt<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token char\">'\\0'</span><span class=\"token punctuation\">)</span>\r\n            name_cnt<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>name_cnt<span class=\"token operator\">></span>SEM_NAME_LEN<span class=\"token punctuation\">)</span>\r\n            <span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>name_cnt<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\r\n            kernelname<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token function\">get_fs_byte</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">+</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> name_len <span class=\"token operator\">=</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span> sem_name_len <span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token comment\">// 判断是否存在，并定位赋值给cnt</span>\r\n    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>cnt<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n        sem_name_len <span class=\"token operator\">=</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>semtable<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>sem_name_len <span class=\"token operator\">==</span> name_len<span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">{</span>\r\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> <span class=\"token operator\">!</span><span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span>kernelname<span class=\"token punctuation\">,</span>semtable<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n                <span class=\"token punctuation\">{</span>\r\n                        isExist <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n                        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\r\n                <span class=\"token punctuation\">}</span>\r\n        <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token comment\">// 存在则删除信号量</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>isExist <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">int</span> tmp<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// 从定位到的cnt位置往后开始向前覆盖，实现删除</span>\r\n        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>tmp<span class=\"token operator\">=</span>i<span class=\"token punctuation\">;</span>tmp<span class=\"token operator\">&lt;=</span>cnt<span class=\"token punctuation\">;</span>tmp<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">{</span>\r\n            semtable<span class=\"token punctuation\">[</span>tmp<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>semtable<span class=\"token punctuation\">[</span>tmp<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token punctuation\">}</span>\r\n        cnt <span class=\"token operator\">=</span> cnt<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 信号量个数减一</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">else</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 不存在则返回</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>3、新增上述四个系统调用</p>\n<ol>\n<li>修改<code class=\"language-text\">/include/unistd.h</code>，添加新增的系统调用的编号：</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__NR_setregid</span>\t<span class=\"token expression\"><span class=\"token number\">71</span></span></span>\r\n<span class=\"token comment\">/* 添加系统调用号 */</span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__NR_sem_open</span>     <span class=\"token expression\"><span class=\"token number\">72</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__NR_sem_wait</span>     <span class=\"token expression\"><span class=\"token number\">73</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__NR_sem_post</span>     <span class=\"token expression\"><span class=\"token number\">74</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__NR_sem_unlink</span>   <span class=\"token expression\"><span class=\"token number\">75</span></span></span></code></pre></div>\n<ol start=\"2\">\n<li>修改<code class=\"language-text\">/kernel/system_call.s</code>，需要修改总的系统调用数</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">nr_system_calls <span class=\"token operator\">=</span> <span class=\"token number\">76</span></code></pre></div>\n<ol start=\"3\">\n<li>修改<code class=\"language-text\">/include/linux/sys.h</code>，声明全局新增函数</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> <span class=\"token function\">sys_sem_open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> <span class=\"token function\">sys_sem_wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> <span class=\"token function\">sys_sem_post</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> <span class=\"token function\">sys_sem_unlink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\nfn_ptr sys_call_table<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n<span class=\"token comment\">//...sys_setreuid,sys_setregid,sys_whoami,sys_iam,</span>\r\nsys_sem_open<span class=\"token punctuation\">,</span>sys_sem_wait<span class=\"token punctuation\">,</span>sys_sem_post<span class=\"token punctuation\">,</span>sys_sem_unlink\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n</code></pre></div>\n<ol start=\"4\">\n<li>修改 <code class=\"language-text\">linux-0.11/kernel/Makefile</code>，添加<code class=\"language-text\">sem.c</code>编译规则</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"makefile\"><pre class=\"language-makefile\"><code class=\"language-makefile\">OBJS  <span class=\"token operator\">=</span> sched.o system_call.o traps.o asm.o fork.o \\\r\n\tpanic.o printk.o vsprintf.o sys.o exit.o \\\r\n\tsignal.o mktime.o who.o sem.o\r\n// ...\r\n<span class=\"token comment\">### Dependencies:</span>\r\n<span class=\"token target symbol\">sem.s sem.o</span><span class=\"token punctuation\">:</span> sem.c ../<span class=\"token keyword\">include</span>/linux/sem.h ../<span class=\"token keyword\">include</span>/linux/kernel.h \\\r\n../<span class=\"token keyword\">include</span>/unistd.h</code></pre></div>\n<h2>三、在linux0.11环境下编译运行</h2>\n<p>前面编写的<code class=\"language-text\">pc.c</code>能够在Ubuntu下运行通过，但在linux0.11系统下不行，需要进行修改，我们复制<code class=\"language-text\">pc.c</code>，创建一个适合在linux0.11环境下编译的`pc2.c'</p>\n<ol>\n<li>在linux0.11系统的应用程序中，注释不能写<code class=\"language-text\">//</code>，必须要写<code class=\"language-text\">/* */</code></li>\n<li>修改头文件，包含上面新建的<code class=\"language-text\">sem.h</code></li>\n<li>修改<code class=\"language-text\">sem_open()</code>的创建方法</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span>   <span class=\"token macro-name\">__LIBRARY__</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/types.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fcntl.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;linux/sem.h></span></span>\r\n\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">M</span> <span class=\"token expression\"><span class=\"token number\">530</span>            </span><span class=\"token comment\">/*打出数字总数*/</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">N</span> <span class=\"token expression\"><span class=\"token number\">5</span>               </span><span class=\"token comment\">/*消费者进程数*/</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">BUFSIZE</span> <span class=\"token expression\"><span class=\"token number\">10</span>      </span><span class=\"token comment\">/*缓冲区大小*/</span></span>\r\n\r\n<span class=\"token function\">_syscall2</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sem_t</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>sem_open<span class=\"token punctuation\">,</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">,</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">_syscall1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>sem_wait<span class=\"token punctuation\">,</span><span class=\"token class-name\">sem_t</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>sem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">_syscall1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>sem_post<span class=\"token punctuation\">,</span><span class=\"token class-name\">sem_t</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>sem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token function\">_syscall1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>sem_unlink<span class=\"token punctuation\">,</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token class-name\">sem_t</span> <span class=\"token operator\">*</span>empty<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>full<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>mutex<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/*3个信号量*/</span>\r\n    <span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">;</span>                       <span class=\"token comment\">/*共享缓冲区文件描述符*/</span>\r\n    <span class=\"token keyword\">int</span>  i<span class=\"token punctuation\">,</span>j<span class=\"token punctuation\">,</span>k<span class=\"token punctuation\">,</span>child<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span>  data<span class=\"token punctuation\">;</span>                    <span class=\"token comment\">/*写入的数据*/</span>\r\n    <span class=\"token class-name\">pid_t</span> pid<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">int</span>  buf_out <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>             <span class=\"token comment\">/*记录上次从缓冲区读取位置*/</span>\r\n    <span class=\"token keyword\">int</span>  buf_in <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>              <span class=\"token comment\">/*记录上次写入缓冲区位置*/</span>\r\n\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>mutex <span class=\"token operator\">=</span> <span class=\"token function\">sem_open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mutex\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sem_open() error!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>empty <span class=\"token operator\">=</span> <span class=\"token function\">sem_open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"empty\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sem_open() error!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>full <span class=\"token operator\">=</span> <span class=\"token function\">sem_open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"full\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">{</span>\r\n        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sem_open() error!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">/* 在文件中存储buf_out（因此生产者只有一个进程，所以buf_in不用存在文件中）*/</span>\r\n    fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"buffer.txt\"</span><span class=\"token punctuation\">,</span> O_CREAT<span class=\"token operator\">|</span>O_TRUNC<span class=\"token operator\">|</span>O_RDWR<span class=\"token punctuation\">,</span><span class=\"token number\">0666</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \r\n    <span class=\"token function\">lseek</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span>BUFSIZE<span class=\"token operator\">*</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token constant\">SEEK_SET</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">/*修改地址偏移在10个数字之后，即40字节位置*/</span>\r\n\r\n<span class=\"token comment\">//  .....（以下内容不变）</span></code></pre></div>\n<p>注意：本人实验过程中发现，如果几个头文件前后放的顺序不同，将导致找不到四个<code class=\"language-text\">sem</code>函数，血的教训，具体原因不知。</p>\n<p>将已经修改的<code class=\"language-text\">pc.c</code>、<code class=\"language-text\">unistd.h</code>和<code class=\"language-text\">sem.h</code>文件拷贝到linux-0.11系统中</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> oslab_Lab5\r\n<span class=\"token function\">sudo</span> ./mount-hdc\r\n<span class=\"token function\">cp</span> ./pc.c ./hdc/usr/root/\r\n<span class=\"token function\">cp</span> ./linux-0.11/include/unistd.h ./hdc/usr/include/ \r\n<span class=\"token function\">cp</span> ./linux-0.11/include/linux/sem.h ./hdc/usr/include/linux/\r\n<span class=\"token function\">sudo</span> <span class=\"token function\">umount</span> hdc</code></pre></div>\n<p>编译及运行Bochs</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> oslab_Lab5/linux-0.11\r\n<span class=\"token function\">make</span> all\r\n<span class=\"token punctuation\">..</span>/run</code></pre></div>\n<p>在linux0.11的Bochs中编译生产者-消费者程序</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">gcc <span class=\"token parameter variable\">-o</span> pc pc.c\r\n./pc <span class=\"token operator\">></span> <span class=\"token number\">1</span>.txt\r\n<span class=\"token function\">sync</span></code></pre></div>\n<p>在Ubuntu中挂载<code class=\"language-text\">hdc</code>，将linux0.11输出的<code class=\"language-text\">1.txt</code>文件移动到Ubuntu中</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo ./mount-hdc\r\nsudo cp ./hdc/usr/root/1.txt ./</code></pre></div>\n<p>打开<code class=\"language-text\">1.txt</code>文件即可见到输出如下：\r\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 124px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/477c9dcd63d6db255d6257c0f858a311/d6e54/3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 212.0967741935484%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/477c9dcd63d6db255d6257c0f858a311/d6e54/3.png\"\n        srcset=\"/blog/static/477c9dcd63d6db255d6257c0f858a311/d6e54/3.png 124w\"\n        sizes=\"(max-width: 124px) 100vw, 124px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\r\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 253px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/768b08895959192185e16ae763127f22/88c73/4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 151.26582278481013%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsTAAALEwEAmpwYAAADTElEQVR42p1WiXKiQBT0/z9rN4eRGBFQQAS5BQQ0GqPRmN6eMRpz1G6xVFmlMPb0e/26h5bnebBHI0ynUwwGQ3juGP7EQ5RkiKIQz88b5FkGZzxGVVXYbreoyhIp1z+tVnJ9EAQ4QFxvaI0dByN+xJ8MAiZxJAGDMEHEhY+PS7hjF2MJWGO1ekJZziRgXZUkMeD6CfaHNwnZ8lwX3fsufD+AM7JRlJV8EJKdYQxQzMrj3m/HP/zrarncWdd1SdsyTeSzmXwQxzEM3s+L4+/D4SBBL4HF99P9M+DEc6H2VcnIsswzoySJoRGwqutmDH0C3t11MJn4sG3rA5AMB4aBer5oWrIDy7aRpinM4ZAlnxgm6Ha7zXsoZNfZ/CiKvpScQNP65x42AhS9iuMEpmWeGcbcwObv1fq5OaDBWZIqC8DiCJimCRRF4cBn3wB/UvszQ+04Nqb5UXJMlXsPD8iKojnDvqZxbGKMbBNpVkgLCZGGdI5guN/vsdlszjP3vF5jzc/hnelqtcTLy8s7IAdb2CeMU8xL+pe9FCMk2JqWhevrK+nxPqvYvx5QzXJ02jfQeW9GVy0WjzSAhiSdXliPpYmSXX73OJe3t7dwnDHncoSnpzUDwIFCe07zXLIXbATb0/X6+vrZKT1VxYg+NgwdYRjJEXKcEUHusWA4lLNC3n9cLk8q/H2wj2mTf1O5c9emONMfVcYF5jcvdzoKfJZsWx/WE1k4HA4wXyybqSwARQ99/6uXI/QZGmU9bwjIsVHVvuzRJ+sRUO31mDYNAQPfw/XNDVxxFLDkUw9jAmqcz8bhIBgOh6YMA9O8SJt3ho3DQfRQnCVh9L3kHgHLqm4OKKwXfU2bd1EaB6wA1HRDqmxdAKYMB6XTkfZqfASIgA3kHH6ULAAfmNhZ0x76E1eOTRCGnwBjDrY5MBiwm/8QhYeR6KE8Rk/Wo+rtdhtZXpyP0Z8CVrrw7QtDEQ4iD48qV2dRFKWDaZY3H2xFuaeXQ/nmkCQp9rsXTBmwOtWvF4tjqPIdRwStuLbbjQzYPWNrt9vJ8N3t9vJ5y2VMyXcalvjQU+EwtTW1h/EkREihxCGlM0DFpmJNPZ8j4LuMIU/KEFe/f/G4vefGS266xh9TrOfOlMLy2gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"在这里插入图片描述\"\n        title=\"\"\n        src=\"/blog/static/768b08895959192185e16ae763127f22/88c73/4.png\"\n        srcset=\"/blog/static/768b08895959192185e16ae763127f22/c26ae/4.png 158w,\n/blog/static/768b08895959192185e16ae763127f22/88c73/4.png 253w\"\n        sizes=\"(max-width: 253px) 100vw, 253px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>","frontmatter":{"title":"【哈工大_操作系统实验】Lab6 信号量的实现和应用","date":"October 11, 2024","description":"本文将介绍哈工大操作系统实验课Lab6 信号量的实现和应用"}},"previous":{"fields":{"slug":"/014_HIT_OS_Lab5/"},"frontmatter":{"title":"【哈工大_操作系统实验】Lab5 基于内核栈切换的进程切换"}},"next":{"fields":{"slug":"/016_HIT_OS_Lab7/"},"frontmatter":{"title":"【哈工大_操作系统实验】Lab7 地址映射与共享"}}},"pageContext":{"id":"a3234939-ea6b-51d3-b87c-5b00bf1a98cc","previousPostId":"bf47b7f4-595d-501d-b207-be0c83d803f8","nextPostId":"6f3e8248-ac12-5c84-862d-01d2e442249c"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}